import socket\nimport threading\nimport sys\n\nHOST = '127.0.0.1'  # Standard loopback interface address (localhost)\nPORT = 65432        # Port to listen on (non-privileged ports are > 1023)\n\nserver = socket.socket(socket.AF_INET, socket.SOCK_STREAM)\n\ntry:\n    server.bind((HOST, PORT))\n    server.listen()\nexcept OSError as e:\n    print(f"Chyba při spuštění serveru: {e}. Ujistěte se, že port {PORT} není již používán.")\n    sys.exit(1)\n\nclients = []\nnicknames = []\n\nprint(f"Server spuštěn a naslouchá na {HOST}:{PORT}")\n\ndef broadcast(message, _client=None):\n    """Odešle zprávu všem připojeným klientům, kromě odesílatele."""\n    for client in clients:\n        try:\n            # Pokud je zpráva od konkrétního klienta, neposílejte ji zpět jemu samotnému\n            if client != _client:\n                client.send(message)\n        except:\n            # Pokud dojde k chybě při odesílání, klient se pravděpodobně odpojil\n            if client in clients:\n                index = clients.index(client)\n                clients.remove(client)\n                client.close()\n                nickname = nicknames[index]\n                nicknames.remove(nickname)\n                print(f"{nickname} se odpojil (během broadcastu).")\n                broadcast(f"{nickname} opustil chat.".encode('utf-8'))\n\ndef handle_client(client):\n    """Stará se o komunikaci s jedním klientem."""\n    while True:\n        try:\n            message = client.recv(1024) # Přijme zprávu od klienta\n            if not message: # Klient se odpojil (prázdná zpráva)\n                raise Exception("Klient se odpojil")\n            \n            # Zprávy přijaté serverem jsou rovnou broadcastovány ostatním\n            broadcast(message, client)\n        except:\n            # Zpracování odpojení klienta\n            if client in clients:\n                index = clients.index(client)\n                clients.remove(client)\n                client.close()\n                nickname = nicknames[index]\n                nicknames.remove(nickname)\n                print(f"{nickname} se odpojil.")\n                broadcast(f"{nickname} opustil chat.".encode('utf-8'))\n            break\n\ndef receive_connections():\n    """Přijímá nové připojení klientů."""\n    while True:\n        client, address = server.accept() # Přijme nové připojení\n        print(f"Připojeno s {str(address)}")\n\n        # Požádá klienta o přezdívku a uloží ji\n        client.send('NICK'.encode('utf-8'))\n        try:\n            nickname = client.recv(1024).decode('utf-8')\n            nicknames.append(nickname)\n            clients.append(client)\n\n            print(f"Přezdívka klienta je {nickname}")\n            # Informuje ostatní o novém připojení\n            broadcast(f"{nickname} se připojil k chatu!".encode('utf-8'), client)\n            client.send('Připojeno k serveru!'.encode('utf-8'))\n\n            # Spustí nové vlákno pro obsluhu tohoto klienta\n            thread = threading.Thread(target=handle_client, args=(client,))\n            thread.start()\n        except:\n            print(f"Nepodařilo se získat přezdívku od {address}. Odpojuji klienta.")\n            client.close()\n\n# Spuštění procesu přijímání připojení\nreceive_connections()\n