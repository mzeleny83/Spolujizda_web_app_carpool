<!DOCTYPE html>
<html>
<head>
    <title>Spoluj√≠zda - Sd√≠len√≠ j√≠zd po cel√© ƒåesk√© republice</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="description" content="Najdƒõte spoluj√≠zdu nebo nab√≠dnƒõte voln√° m√≠sta ve sv√©m autƒõ. Levn√© cestov√°n√≠ po ƒåesk√© republice - Praha, Brno, Ostrava.">
    <meta name="keywords" content="spoluj√≠zda, sd√≠len√≠ j√≠zd, levn√© cestov√°n√≠, Praha, Brno, Ostrava">
    <meta property="og:title" content="Spoluj√≠zda - Sd√≠len√≠ j√≠zd">
    <meta property="og:description" content="Najdƒõte spoluj√≠zdu nebo nab√≠dnƒõte voln√° m√≠sta ve sv√©m autƒõ">
    <link rel="canonical" href="https://www.sveztese.cz/">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/static/js/script_v400.js"></script>
    <script src="/static/js/location_fix.js"></script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/static/js/sw.js').then(function(registration) {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, function(err) {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
    </script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #007bff; padding-bottom: 20px; }
        .nav { display: flex; gap: 15px; flex-wrap: wrap; }
        .nav button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .nav button.active { background: #0056b3; }
        .section { display: none; }
        .section.active { display: block !important; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; }
        .btn { padding: 15px 30px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .search-form { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        .ride { border: 1px solid #ddd; margin: 15px 0; padding: 20px; border-radius: 8px; background: #f9f9f9; }
        .user-info { background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .message { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: center;
            }
            .nav {
                justify-content: center;
                margin-top: 15px;
            }
        }

        @media (max-width: 600px) {
          #floatingChat {
            right: auto !important;
            left: 10px !important;
            width: calc(100% - 20px) !important;
            bottom: 10px !important;
          }
        }
    </style>
    <script>
        // Force override cached functions

        
        // Complete notification system inline
        
        
    </script>
    <script>
        let currentUser = null;
        let currentChatRide = null;
        let currentChatType = null;
        let rideMarkers = [];

        function showMessage(text, type = 'success') {
            const msg = document.getElementById('message');
            msg.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => msg.innerHTML = '', 5000);
        }

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            
            // Najdi a aktivuj spr√°vn√© tlaƒç√≠tko
            const buttons = document.querySelectorAll('.nav button');
            buttons.forEach(btn => {
                if (btn.textContent.includes('Hledat') && section === 'search') btn.classList.add('active');
                if (btn.textContent.includes('Mapa') && section === 'map') btn.classList.add('active');
                if (btn.textContent.includes('Moje rezervace') && section === 'reservations') btn.classList.add('active');
                if (btn.textContent.includes('Mnou nab√≠zen√©') && section === 'my-rides') btn.classList.add('active');
                if (btn.textContent.includes('Chat') && section === 'chat') btn.classList.add('active');
                if (btn.textContent.includes('Nab√≠dnout') && section === 'offer') btn.classList.add('active');
                if (btn.textContent.includes('P≈ôihl√°sit') && section === 'login') btn.classList.add('active');
                if (btn.textContent.includes('Registrovat') && section === 'register') btn.classList.add('active');
            });
            
            // Automatick√© naƒç√≠t√°n√≠ dat p≈ôi p≈ôepnut√≠ na sekci
            if (section === 'reservations') {
                loadReservations();
            } else if (section === 'my-rides') {
                loadMyRides();
            } else if (section === 'search') {
                setTimeout(() => {
                    if (!searchMap) initSearchMap();
                }, 100);
                setTimeout(() => {
                    autoUpdateLocation();
                }, 1000);
            } else if (section === 'map') {
                setTimeout(() => {
                    if (!map) initRealMap();
                    loadMapRides();
                }, 100);
            }
        }

        function updateUI() {
            if (currentUser) {
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userInfo').innerHTML = `P≈ôihl√°≈°en jako: <strong>${currentUser.name}</strong> (${currentUser.phone}) ‚≠ê ${currentUser.rating || 5.0}`;
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('registerBtn').style.display = 'none';
                document.getElementById('offerBtn').style.display = 'inline-block';
                document.getElementById('reservationsBtn').style.display = 'inline-block';
                document.getElementById('myRidesBtn').style.display = 'inline-block';
                document.getElementById('usersBtn').style.display = 'inline-block';
                document.getElementById('logoutBtn').style.display = 'inline-block';
            } else {
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('loginBtn').style.display = 'inline-block';
                document.getElementById('registerBtn').style.display = 'inline-block';
                document.getElementById('offerBtn').style.display = 'none';
                document.getElementById('reservationsBtn').style.display = 'none';
                document.getElementById('myRidesBtn').style.display = 'none';
                document.getElementById('usersBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'none';
            }
        }

        async function register() {
            if (!document.getElementById('agreeTerms').checked) {
                showMessage('Mus√≠te souhlasit s obchodn√≠mi podm√≠nkami', 'error');
                return;
            }
            if (!document.getElementById('agreePrivacy').checked) {
                showMessage('Mus√≠te souhlasit se zpracov√°n√≠m osobn√≠ch √∫daj≈Ø', 'error');
                return;
            }
            

            
            const name = document.getElementById('regName').value.trim();
            const forbiddenNames = ['nezn√°m√Ω ≈ôidiƒç', 'nezn√°m√Ω', 'unknown', 'driver', '≈ôidiƒç', 'nezn√°my ridic', 'test', 'user'];
            
            if (name.length < 2) {
                showMessage('Jm√©no mus√≠ m√≠t alespo≈à 2 znaky', 'error');
                return;
            }
            
            if (forbiddenNames.some(forbidden => name.toLowerCase().includes(forbidden))) {
                showMessage('Zadejte platn√© jm√©no a p≈ô√≠jmen√≠', 'error');
                return;
            }
            
            const data = {
                name: name,
                phone: document.getElementById('regPhone').value,
                email: document.getElementById('regEmail').value,
                home_city: document.getElementById('regCity').value,
                password: document.getElementById('regPassword').value,
                password_confirm: document.getElementById('regPasswordConfirm').value,
                paypal_email: document.getElementById('regPaypalEmail').value
            };

            try {
                const response = await fetch('/api/users/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('Registrace √∫spƒõ≈°n√°! Nyn√≠ se m≈Ø≈æete p≈ôihl√°sit.');
                    showSection('login');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage('Chyba p≈ôi registraci: ' + error.message, 'error');
            }
        }

        async function login() {
            const data = {
                phone: document.getElementById('loginPhone').value,
                password: document.getElementById('loginPassword').value
            };

            try {
                const response = await fetch('/api/users/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (response.ok) {
                    currentUser = {
                        id: result.user_id,
                        name: result.name,
                        phone: document.getElementById('loginPhone').value,
                        rating: result.rating || 5.0
                    };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    updateUI();
                    showMessage('P≈ôihl√°≈°en√≠ √∫spƒõ≈°n√©!');
                    console.log('LOGIN v359: Starting notification check after login');
                    setTimeout(() => {
                        if (typeof startNotificationCheck === 'function') {
                            startNotificationCheck();
                        } else {
                            console.error('startNotificationCheck function not found!');
                        }
                    }, 1000);
                    showSection('search');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage('Chyba p≈ôi p≈ôihl√°≈°en√≠: ' + error.message, 'error');
            }
        }

        function logout() {
            if (typeof stopNotificationCheck === 'function') {
                stopNotificationCheck();
            }
            currentUser = null;
            localStorage.removeItem('currentUser');
            updateUI();
            showMessage('Odhl√°≈°en√≠ √∫spƒõ≈°n√©!');
            showSection('search');
        }

        async function offerRide() {
            if (!currentUser) {
                showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                return;
            }

            const fromCity = document.getElementById('offerFrom').value;
            const fromStreet = document.getElementById('offerFromStreet').value;
            const toCity = document.getElementById('offerTo').value;
            const toStreet = document.getElementById('offerToStreet').value;
            
            const data = {
                user_id: currentUser.id,
                from_location: fromStreet ? `${fromCity}, ${fromStreet}` : fromCity,
                to_location: toStreet ? `${toCity}, ${toStreet}` : toCity,
                departure_time: document.getElementById('offerTime').value,
                available_seats: parseInt(document.getElementById('offerSeats').value),
                price_per_person: parseInt(document.getElementById('offerPrice').value),
                route_waypoints: []
            };

            try {
                const response = await fetch('/api/rides/offer', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('J√≠zda √∫spƒõ≈°nƒõ nab√≠dnuta!');
                    document.getElementById('offer').querySelectorAll('input').forEach(i => i.value = '');
                    showSection('search');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage('Chyba p≈ôi nab√≠zen√≠ j√≠zdy: ' + error.message, 'error');
            }
        }

        async function search() {
            const from = document.getElementById('from').value.trim();
            const fromStreet = document.getElementById('fromStreet') ? document.getElementById('fromStreet').value.trim() : '';
            const to = document.getElementById('to').value.trim();
            const toStreet = document.getElementById('toStreet') ? document.getElementById('toStreet').value.trim() : '';
            
            // Kombinuj mƒõsto a ulici
            const fromFull = fromStreet ? `${from}, ${fromStreet}` : from;
            const toFull = toStreet ? `${to}, ${toStreet}` : to;
            const rangeSlider = document.getElementById('searchRange').value;
            const results = document.getElementById('searchResults');
            
            results.innerHTML = '‚è≥ Hled√°m j√≠zdy...';
            
            try {
                let url = '/api/rides/search?';
                if (fromFull) url += `from=${encodeURIComponent(fromFull)}&`;
                if (toFull) url += `to=${encodeURIComponent(toFull)}&`;
                
                // P≈ôidej datum a ƒças filtry
                const dateFrom = document.getElementById('dateFrom').value;
                const dateTo = document.getElementById('dateTo').value;
                const timeFrom = document.getElementById('timeFrom').value;
                const timeTo = document.getElementById('timeTo').value;
                
                if (dateFrom) url += `date_from=${dateFrom}&`;
                if (dateTo) url += `date_to=${dateTo}&`;
                if (timeFrom) url += `time_from=${timeFrom}&`;
                if (timeTo) url += `time_to=${timeTo}&`;
                
                // P≈ôidej GPS polohu a vzd√°lenost pokud je dostupn√°
                if (currentLocation && rangeSlider > 0) {
                    const actualRange = Math.round(Math.pow(rangeSlider / 100 * 300, 1.5) / 10);
                    url += `lat=${currentLocation.lat}&lng=${currentLocation.lng}&range=${actualRange}&`;
                } else if (rangeSlider > 0 && !currentLocation) {
                    showMessage('Pro filtrovan√© vyhled√°v√°n√≠ mus√≠te zapnout GPS polohu', 'error');
                    return;
                }
                
                const response = await fetch(url);
                const rides = await response.json();
                
                if (rides.length === 0) {
                    results.innerHTML = '<div style="text-align:center;color:#666;margin:30px 0;">‚ùå ≈Ω√°dn√© j√≠zdy nenalezeny</div>';
                    return;
                }
                
                results.innerHTML = rides.map(ride => `
                    <div class="ride">
                        <h3>${ride.from_location} ‚Üí ${ride.to_location}</h3>
                        <div>üïê ${ride.departure_time} | üë• ${ride.available_seats} m√≠st | üí∞ ${ride.price_per_person} Kƒç</div>
                        <div>üöó ${ride.driver_name || 'Nezn√°m√Ω ≈ôidiƒç'} ‚≠ê ${ride.driver_rating || 5.0} <button onclick="showDriverReviews('${ride.driver_name}')" style="background: #17a2b8; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 11px; cursor: pointer; margin-left: 5px;">üí¨ Recenze</button></div>
                        <div style="margin-top: 10px;">
                            <button class="btn" onclick="reserveRide(${ride.id})" style="background: #28a745; margin-right: 10px;">üé´ Rezervovat</button>
                            <button class="btn btn-success" onclick="payForRide(${ride.id}, ${ride.price_per_person})">üí≥ Zaplatit</button>
                            <button class="btn" onclick="openChat('passenger', ${ride.id}, '${ride.driver_name}')" style="background: #17a2b8; margin-left: 10px; padding: 5px 15px;">üí¨ Chat s ≈ôidiƒçem</button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                results.innerHTML = '‚ùå Chyba: ' + error.message;
            }
        }

        async function showAll() {
            const results = document.getElementById('searchResults');
            results.innerHTML = '‚è≥ Naƒç√≠t√°m v≈°echny j√≠zdy...';
            
            try {
                // Ignoruj GPS filtr - naƒçti v≈°echny j√≠zdy bez omezen√≠
                const response = await fetch('/api/rides/search');
                const rides = await response.json();
                
                if (rides.length === 0) {
                    results.innerHTML = '<div style="text-align:center;color:#666;margin:30px 0;">‚ùå ≈Ω√°dn√© j√≠zdy nenalezeny</div>';
                    return;
                }
                
                results.innerHTML = rides.map(ride => `
                    <div class="ride">
                        <h3>${ride.from_location} ‚Üí ${ride.to_location}</h3>
                        <div>üïê ${ride.departure_time} | üë• ${ride.available_seats} m√≠st | üí∞ ${ride.price_per_person} Kƒç</div>
                        <div>üöó ${ride.driver_name || 'Nezn√°m√Ω ≈ôidiƒç'} <button onclick="showDriverReviews('${ride.driver_name}')" style="background: #17a2b8; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 11px; cursor: pointer; margin-left: 5px;">üí¨ Recenze</button></div>
                        <div style="margin-top: 10px;">
                            <button class="btn" onclick="reserveRide(${ride.id})" style="background: #28a745; margin-right: 10px;">üé´ Rezervovat</button>
                            <button class="btn btn-success" onclick="payForRide(${ride.id}, ${ride.price_per_person})">üí≥ Zaplatit</button>
                            <button class="btn" onclick="openChat('passenger', ${ride.id}, '${ride.driver_name}')" style="background: #17a2b8; margin-left: 10px; padding: 5px 15px;">üí¨ Chat s ≈ôidiƒçem</button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                results.innerHTML = '‚ùå Chyba: ' + error.message;
            }
        }

        
        
        let map;
        let markers = [];
        
        function initRealMap() {
            if (map) return;
            
            // Vytvo≈ô mapu st≈ôed ƒåR
            map = L.map('realMap').setView([49.75, 15.5], 7);
            
            // P≈ôidej OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        async function loadMapRides() {
            if (!map) {
                initRealMap(); // Ensure map is initialized
            }

            // Clear existing ride markers
            rideMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            rideMarkers = [];

            const mapRidesList = document.getElementById('mapRidesList');
            mapRidesList.innerHTML = '‚è≥ Naƒç√≠t√°m j√≠zdy na mapu...';

            try {
                const response = await fetch('/api/rides/search'); // Fetch all rides
                const rides = await response.json();
                console.log('Rides from API:', rides);

                if (rides.length === 0) {
                    mapRidesList.innerHTML = '<div style="text-align:center;color:#666;margin:30px 0;">‚ùå ≈Ω√°dn√© j√≠zdy nenalezeny pro zobrazen√≠ na mapƒõ</div>';
                    return;
                }

                let bounds = L.latLngBounds(); // To fit all markers on the map
                mapRidesList.innerHTML = ''; // Clear the list

                rides.forEach(ride => {
                    console.log('Processing ride:', ride);

                    if (ride.from_lat && ride.from_lng && ride.to_lat && ride.to_lng) {
                        const fromLatLng = [ride.from_lat, ride.from_lng];
                        const toLatLng = [ride.to_lat, ride.to_lng];

                        const fromMarker = L.marker(fromLatLng, {
                            icon: L.divIcon({
                                html: '<div style="background: #4caf50; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">START</div>',
                                iconSize: [25, 25],
                                iconAnchor: [12, 12]
                            })
                        }).addTo(map);
                        fromMarker.bindPopup(`<b>${ride.from_location}</b><br>Odkud`);
                        rideMarkers.push(fromMarker);
                        bounds.extend(fromLatLng);

                        const toMarker = L.marker(toLatLng, {
                            icon: L.divIcon({
                                html: '<div style="background: #f44336; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">C√çL</div>',
                                iconSize: [25, 25],
                                iconAnchor: [12, 12]
                            })
                        }).addTo(map);
                        toMarker.bindPopup(`<b>${ride.to_location}</b><br>Kam`);
                        rideMarkers.push(toMarker);
                        bounds.extend(toLatLng);

                        const routeLine = L.polyline([fromLatLng, toLatLng], { color: '#2196f3', weight: 3 }).addTo(map);
                        rideMarkers.push(routeLine);
                    }

                    // Display ride details in the list
                    mapRidesList.innerHTML += `
                        <div class="ride">
                            <h3>${ride.from_location} ‚Üí ${ride.to_location}</h3>
                            <div>üïê ${ride.departure_time} | üë• ${ride.available_seats} m√≠st | üí∞ ${ride.price_per_person} Kƒç</div>
                            <div>üöó ${ride.driver_name || 'Nezn√°m√Ω ≈ôidiƒç'}</div>
                            <div style="margin-top: 10px;">
                                <button class="btn" onclick="openChat('passenger', ${ride.id}, '${ride.driver_name}')" style="background: #17a2b8; padding: 5px 15px;">üí¨ Chat s ≈ôidiƒçem</button>
                            </div>
                        </div>
                    `;
                });

                if (bounds.isValid()) {
                    map.fitBounds(bounds); // Adjust map view to fit all markers
                }

            } catch (error) {
                mapRidesList.innerHTML = '‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ j√≠zd na mapu: ' + error.message;
            }
        }


        
        
        async function reserveRide(rideId) {
            if (!currentUser) {
                showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/reservations/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ride_id: rideId,
                        passenger_id: currentUser.id,
                        seats_reserved: 1
                    })
                });
                
                let result;
                try {
                    result = await response.json();
                } catch (jsonError) {
                    // Server vr√°til HTML m√≠sto JSON
                    const text = await response.text();
                    showMessage(`Chyba serveru (${response.status}): ${text.substring(0, 100)}...`, 'error');
                    return;
                }
                
                if (response.ok) {
                    showMessage('J√≠zda √∫spƒõ≈°nƒõ rezervov√°na!');
                    // Obnov seznam j√≠zd
                    if (document.getElementById('search').classList.contains('active')) {
                        showAll();
                    }
                    // Automaticky p≈ôejdi na rezervace
                    setTimeout(() => {
                        showSection('reservations');
                        loadReservations();
                    }, 2000);
                } else {
                    showMessage(result.error || `HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                showMessage('Chyba p≈ôi rezervaci: ' + error.message, 'error');
            }
        }
        
        async function payForRide(rideId, price) {
            if (!currentUser) {
                showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                return;
            }
            
            showMessage('P≈ôipravuji platbu...', 'info');
            
            try {
                const response = await fetch('/api/payments/create-checkout-session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ride_id: rideId,
                        user_id: currentUser.id,
                        amount: price
                    })
                });
                
                const session = await response.json();
                console.log('Payment response:', session);
                
                if (response.ok && session.checkout_url) {
                    showMessage('Otev√≠r√°m PayPal v nov√©m oknƒõ...');
                    window.open(session.checkout_url, '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
                } else {
                    showMessage(session.error || 'Chyba p≈ôi vytv√°≈ôen√≠ platby', 'error');
                }
            } catch (error) {
                console.error('Payment error:', error);
                showMessage('Chyba p≈ôi platbƒõ: ' + error.message, 'error');
            }
        }
        
        async function loadReservations() {
            if (!currentUser) {
                showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                return;
            }
            
            const reservationsList = document.getElementById('reservationsList');
            reservationsList.innerHTML = '‚è≥ Naƒç√≠t√°m va≈°e rezervace...';
            
            try {
                const response = await fetch(`/api/reservations/user/${currentUser.id}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const reservations = await response.json();
                
                if (reservations.length === 0) {
                    reservationsList.innerHTML = '<div style="text-align:center;color:#666;margin:30px 0;">‚ùå ≈Ω√°dn√© rezervace</div>';
                    return;
                }
                
                reservationsList.innerHTML = reservations.map(reservation => {
                    const isPaid = reservation.is_paid;
                    const paymentStatus = isPaid ? 
                        '<span style="background: #28a745; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px;">‚úì Zaplaceno</span>' :
                        '<span style="background: #ffc107; color: black; padding: 5px 10px; border-radius: 15px; font-size: 12px;">‚è≥ Nezaplaceno</span>';
                    
                    const payButton = isPaid ? '' :
                        `<button class="btn btn-success" onclick="payForReservation(${reservation.reservation_id}, ${reservation.price_per_person})" style="margin-left: 10px; padding: 5px 15px;">üí≥ Zaplatit</button>`;
                    
                    return `
                        <div class="ride">
                            <h3>${reservation.from_location} ‚Üí ${reservation.to_location}</h3>
                            <div>üïê ${reservation.departure_time} | üé´ ${reservation.seats_reserved} m√≠sto | üí∞ ${reservation.price_per_person} Kƒç</div>
                            <div>üöó ≈òidiƒç: ${reservation.driver_name || 'Nezn√°m√Ω'} | üìû ${reservation.driver_phone || 'Bez telefonu'}</div>
                            <div style="margin-top: 10px;">
                                ${paymentStatus}
                                <button class="btn" onclick="openChat('passenger', ${reservation.reservation_id}, '${reservation.driver_name}')" style="background: #17a2b8; margin-left: 10px; padding: 5px 15px;">üí¨ Chat s ≈ôidiƒçem</button>
                                <button class="btn" onclick="rateDriver(${reservation.reservation_id}, '${reservation.driver_name}')" style="background: #ffc107; margin-left: 10px; padding: 5px 15px;">‚≠ê Hodnotit ≈ôidiƒçe</button>
                                <button class="btn" onclick="editReservation(${reservation.reservation_id})" style="background: #6f42c1; margin-left: 10px; padding: 5px 15px;">‚úèÔ∏è Upravit j√≠zdu</button>
                                ${payButton}
                                <button class="btn btn-danger" onclick="cancelReservation(${reservation.reservation_id})" style="margin-left: 10px; padding: 5px 15px;">‚ùå Zru≈°it</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                reservationsList.innerHTML = '‚ùå Chyba p≈ôi naƒç√≠t√°n√≠: ' + error.message;
            }
        }
        
        async function payForReservation(reservationId, price) {
            if (!currentUser) {
                showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                return;
            }
            
            try {
                // Nejd≈ô√≠ve z√≠skej ride_id z rezervace
                const reservationResponse = await fetch(`/api/reservations/${reservationId}`);
                if (!reservationResponse.ok) {
                    showMessage('Rezervace nenalezena', 'error');
                    return;
                }
                
                const reservation = await reservationResponse.json();
                const rideId = reservation.ride_id;
                
                const response = await fetch('/api/payments/create-checkout-session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ride_id: rideId, // Pou≈æij skuteƒçn√© ride_id
                        user_id: currentUser.id,
                        amount: price
                    })
                });
                
                const session = await response.json();
                
                if (response.ok) {
                    window.open(session.checkout_url, '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
                } else {
                    showMessage(session.error, 'error');
                }
            } catch (error) {
                showMessage('Chyba p≈ôi platbƒõ: ' + error.message, 'error');
            }
        }
        
        async function cancelReservation(reservationId) {
            if (!confirm('Opravdu chcete zru≈°it tuto rezervaci?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/reservations/cancel/${reservationId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('Rezervace zru≈°ena!');
                    loadReservations(); // Obnov seznam
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage('Chyba p≈ôi ru≈°en√≠: ' + error.message, 'error');
            }
        }
        
        function editReservation(reservationId) {
            const newSeats = prompt('Zadejte nov√Ω poƒçet m√≠st (1-4):');
            if (!newSeats || newSeats < 1 || newSeats > 4) {
                showMessage('Neplatn√Ω poƒçet m√≠st', 'error');
                return;
            }
            
            fetch(`/api/reservations/edit/${reservationId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({seats_reserved: parseInt(newSeats)})
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showMessage('Rezervace upravena!');
                    loadReservations();
                } else {
                    showMessage(result.error, 'error');
                }
            })
            .catch(error => {
                showMessage('Chyba p≈ôi √∫pravƒõ: ' + error.message, 'error');
            });
        }
        
        async function loadMyRides() {
            if (!currentUser) {
                showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                return;
            }
            
            console.log('Loading rides for user:', currentUser.id); // Debug
            
            const myRidesList = document.getElementById('myRidesList');
            myRidesList.innerHTML = '‚è≥ Naƒç√≠t√°m va≈°e j√≠zdy...';
            
            try {
                const response = await fetch(`/api/rides/driver/${currentUser.id}`);
                
                console.log('API response:', response.status); // Debug
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const rides = await response.json();
                console.log('Rides found:', rides.length, rides); // Debug
                
                if (rides.length === 0) {
                    myRidesList.innerHTML = '<div style="text-align:center;color:#666;margin:30px 0;">‚ùå ≈Ω√°dn√© nab√≠zen√© j√≠zdy</div>';
                    return;
                }
                
                myRidesList.innerHTML = rides.map(ride => `
                    <div class="ride">
                        <h3>${ride.from_location} ‚Üí ${ride.to_location}</h3>
                        <div>üïê ${ride.departure_time} | üë• ${ride.available_seats} voln√Ωch m√≠st | üí∞ ${ride.price_per_person} Kƒç</div>
                        <div>üìã Rezervace: ${ride.reservations_count || 0} | üí∞ P≈ô√≠jem: ${(ride.reservations_count || 0) * ride.price_per_person} Kƒç</div>
                        <div id="passengers-${ride.id}" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">‚è≥ Naƒç√≠t√°m pasa≈æ√©ry...</div>
                        <div style="margin-top: 10px;">
                            <button class="btn" onclick="viewRideReservations(${ride.id})" style="background: #17a2b8; margin-right: 10px;">üë• Detail rezervac√≠</button>
                            <button class="btn" onclick="openChat('driver', ${ride.id}, 'Pasa≈æ√©≈ôi')" style="background: #6f42c1; margin-right: 10px;">üí¨ Chat</button>
                            <button class="btn btn-danger" onclick="cancelRide(${ride.id})">‚ùå Zru≈°it j√≠zdu</button>
                        </div>
                    </div>
                `).join('');
                
                // Naƒçti pasa≈æ√©ry pro ka≈ædou j√≠zdu
                rides.forEach(ride => loadPassengersForRide(ride.id));
                
            } catch (error) {
                myRidesList.innerHTML = '‚ùå Chyba p≈ôi naƒç√≠t√°n√≠: ' + error.message;
            }
        }
        
        async function viewRideReservations(rideId) {
            try {
                const response = await fetch(`/api/rides/${rideId}/reservations`);
                const reservations = await response.json();
                
                if (reservations.length === 0) {
                    showMessage('≈Ω√°dn√© rezervace pro tuto j√≠zdu');
                    return;
                }
                
                let reservationsList = reservations.map(res => 
                    `‚Ä¢ ${res.passenger_name}\n  üìû ${res.passenger_phone}\n  üé´ ${res.seats_reserved} m√≠sto\n`
                ).join('\n');
                
                alert(`Rezervace pro j√≠zdu:\n\n${reservationsList}`);
                
            } catch (error) {
                showMessage('Chyba p≈ôi naƒç√≠t√°n√≠ rezervac√≠: ' + error.message, 'error');
            }
        }
        
        async function cancelRide(rideId) {
            if (!confirm('Opravdu chcete zru≈°it tuto j√≠zdu? V≈°echny rezervace budou zru≈°eny.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/rides/cancel/${rideId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('J√≠zda zru≈°ena!');
                    loadMyRides(); // Obnov seznam
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage('Chyba p≈ôi ru≈°en√≠ j√≠zdy: ' + error.message, 'error');
            }
        }
        
        async function openChat(type, rideId, partnerName) {
            console.log('CHAT v302 - Opening chat with:', partnerName, 'for ride:', rideId);
            
            if (!currentUser) {
                alert('Mus√≠te se p≈ôihl√°sit pro pou≈æit√≠ chatu!');
                return;
            }
            
            // Odstra≈à star√© modaly
            const existingModals = document.querySelectorAll('.chat-modal');
            existingModals.forEach(m => m.remove());
            
            // Vytvo≈ô modal okno s !important styly
            const modal = document.createElement('div');
            modal.className = 'chat-modal';
            modal.style.cssText = 'position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; background: rgba(0,0,0,0.7) !important; z-index: 999999 !important; display: flex !important; justify-content: center !important; align-items: center !important; pointer-events: auto !important;';
            
            modal.innerHTML = `
                <div style="background: white !important; width: 90% !important; max-width: 500px !important; height: 80% !important; max-height: 600px !important; border-radius: 15px !important; padding: 25px !important; position: relative !important; box-shadow: 0 10px 30px rgba(0,0,0,0.5) !important; pointer-events: auto !important;" onclick="event.stopPropagation()">
                    <button onclick="this.closest('.chat-modal').remove()" style="position: absolute !important; top: 15px !important; right: 15px !important; background: #ff4444 !important; color: white !important; border: none !important; width: 30px !important; height: 30px !important; border-radius: 50% !important; cursor: pointer !important; font-size: 16px !important; display: flex !important; align-items: center !important; justify-content: center !important;">√ó</button>
                    <h2 style="margin: 0 0 20px 0 !important; color: #333 !important;">Chat s ${partnerName}</h2>
                    <div id="modalChatMessages" style="height: calc(100% - 120px) !important; overflow-y: auto !important; border: 2px solid #eee !important; padding: 15px !important; margin-bottom: 15px !important; background: #fafafa !important; border-radius: 8px !important;">Naƒç√≠t√°m zpr√°vy...</div>
                    <div style="display: flex !important; gap: 10px !important;">
                        <input type="text" id="modalChatInput" placeholder="Napi≈°te zpr√°vu..." style="flex: 1 !important; padding: 12px !important; border: 2px solid #ddd !important; border-radius: 8px !important; font-size: 14px !important;" onkeypress="if(event.key==='Enter') sendModalMessage(${rideId})">
                        <button onclick="sendModalMessage(${rideId})" style="background: #4CAF50 !important; color: white !important; border: none !important; padding: 12px 20px !important; border-radius: 8px !important; cursor: pointer !important; font-weight: bold !important;">Odeslat</button>
                    </div>
                </div>
            `;
            
            // P≈ôidej onclick na modal pozad√≠
            modal.onclick = (e) => {
                if (e.target === modal) {
                    clearInterval(window.chatInterval);
                    modal.remove();
                }
            };
            
            document.body.appendChild(modal);
            console.log('Modal appended to body, checking visibility...');
            
            // Debug - zkontroluj, zda je modal viditeln√Ω
            setTimeout(() => {
                const modalElement = document.querySelector('.chat-modal');
                if (modalElement) {
                    console.log('Modal found in DOM:', modalElement.style.display);
                    console.log('Modal computed style:', window.getComputedStyle(modalElement).display);
                    console.log('Modal position:', modalElement.getBoundingClientRect());
                    console.log('Modal z-index:', window.getComputedStyle(modalElement).zIndex);
                    
                    // Modal je viditeln√Ω, u≈æ nepot≈ôebujeme debug
                } else {
                    console.log('Modal NOT found in DOM!');
                }
            }, 100);
            
            // Naƒçti zpr√°vy
            loadModalChatMessages(rideId);
            
            // Automatick√© obnovov√°n√≠
            window.chatInterval = setInterval(() => loadModalChatMessages(rideId), 3000);
        }
        
        async function sendModalMessage(rideId) {
            const input = document.getElementById('modalChatInput');
            const message = input.value.trim();
            if (!message) return;
            
            try {
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ride_id: rideId,
                        sender_name: currentUser.name,
                        message: message
                    })
                });
                
                if (response.ok) {
                    input.value = '';
                    loadModalChatMessages(rideId);
                }
            } catch (error) {
                console.error('Chyba p≈ôi odes√≠l√°n√≠:', error);
            }
        }
        
        async function loadModalChatMessages(rideId) {
            try {
                const response = await fetch('/api/chat/' + rideId + '/messages');
                const messages = await response.json();
                
                const messagesDiv = document.getElementById('modalChatMessages');
                if (!messagesDiv) return;
                
                messagesDiv.innerHTML = '';
                
                messages.forEach(msg => {
                    const div = document.createElement('div');
                    const isMyMessage = msg.sender_name === currentUser.name;
                    div.style.cssText = `margin: 8px 0; padding: 8px; border-radius: 8px; ${isMyMessage ? 'background: #e3f2fd; text-align: right; margin-left: 50px;' : 'background: #f5f5f5; margin-right: 50px;'}`;
                    const now = new Date();
                    const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                    div.innerHTML = `<strong>${msg.sender_name}:</strong> ${msg.message}<br><small style="color: #666;">${timeStr}</small>`;
                    messagesDiv.appendChild(div);
                });
                
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ zpr√°v:', error);
            }
        }
        
        function closeFloatingChat() {
            document.getElementById('floatingChat').style.display = 'none';
            currentChatRide = null;
            currentChatType = null;
        }
        
        function showFloatingChat(rideId, partnerName) {
            document.getElementById('floatingChat').style.display = 'block';
            document.getElementById('floatingChatTitle').textContent = `üí¨ Chat s ${partnerName}`;
            currentChatRide = rideId;
            loadFloatingChatMessages(rideId);
        }
        
        async function loadFloatingChatMessages(rideId) {
            try {
                const response = await fetch(`/api/chat/${rideId}/messages`);
                const messages = await response.json();
                
                const chatMessages = document.getElementById('floatingChatMessages');
                
                if (messages.length === 0) {
                    chatMessages.innerHTML = '<p style="text-align: center; color: #666; font-size: 14px;">Zat√≠m ≈æ√°dn√© zpr√°vy...</p>';
                    return;
                }
                
                chatMessages.innerHTML = messages.map(msg => {
                    const isOwn = msg.sender_id === currentUser.id;
                    const align = isOwn ? 'right' : 'left';
                    const bgColor = isOwn ? '#007bff' : '#6c757d';
                    
                    return `
                        <div style="text-align: ${align}; margin: 8px 0;">
                            <div style="display: inline-block; background: ${bgColor}; color: white; padding: 6px 10px; border-radius: 12px; max-width: 80%; font-size: 14px;">
                                <div style="font-size: 11px; opacity: 0.8;">${msg.sender_name}</div>
                                <div>${msg.message}</div>
                                <div style="font-size: 10px; opacity: 0.6;">${new Date(msg.created_at).toLocaleTimeString()}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Scroll na konec
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
            } catch (error) {
                document.getElementById('floatingChatMessages').innerHTML = '‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ zpr√°v';
            }
        }
        
        async function sendFloatingMessage() {
            const messageInput = document.getElementById('floatingMessageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentUser || !currentChatRide) {
                return;
            }
            
            try {
                // Ulo≈æ zpr√°vu do datab√°ze
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ride_id: currentChatRide,
                        sender_id: currentUser.id,
                        message: message
                    })
                });
                
                if (response.ok) {
                    messageInput.value = '';
                    loadFloatingChatMessages(currentChatRide);
                } else {
                    showMessage('Chyba p≈ôi odes√≠l√°n√≠ zpr√°vy', 'error');
                }
                
            } catch (error) {
                showMessage('Chyba p≈ôi odes√≠l√°n√≠: ' + error.message, 'error');
            }
        }
        
        async function loadChatMessages(rideId) {
            try {
                const response = await fetch(`/api/chat/${rideId}/messages`);
                const messages = await response.json();
                
                const chatMessages = document.getElementById('chatMessages');
                
                if (messages.length === 0) {
                    chatMessages.innerHTML = '<p style="text-align: center; color: #666;">Zat√≠m ≈æ√°dn√© zpr√°vy...</p>';
                    return;
                }
                
                chatMessages.innerHTML = messages.map(msg => {
                    const isOwn = msg.sender_id === currentUser.id;
                    const align = isOwn ? 'right' : 'left';
                    const bgColor = isOwn ? '#007bff' : '#6c757d';
                    
                    return `
                        <div style="text-align: ${align}; margin: 10px 0;">
                            <div style="display: inline-block; background: ${bgColor}; color: white; padding: 8px 12px; border-radius: 15px; max-width: 70%;">
                                <div style="font-size: 12px; opacity: 0.8;">${msg.sender_name}</div>
                                <div>${msg.message}</div>
                                <div style="font-size: 10px; opacity: 0.6;">${new Date(msg.created_at).toLocaleTimeString()}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Scroll na konec
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
            } catch (error) {
                document.getElementById('chatMessages').innerHTML = '‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ zpr√°v';
            }
        }
        
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentUser || !currentChatRide) {
                return;
            }
            
            try {
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ride_id: currentChatRide,
                        sender_id: currentUser.id,
                        message: message
                    })
                });
                
                if (response.ok) {
                    messageInput.value = '';
                    loadChatMessages(currentChatRide); // Obnov zpr√°vy
                } else {
                    showMessage('Chyba p≈ôi odes√≠l√°n√≠ zpr√°vy', 'error');
                }
                
            } catch (error) {
                showMessage('Chyba p≈ôi odes√≠l√°n√≠: ' + error.message, 'error');
            }
        }
        
        async function loadPassengersForRide(rideId) {
            try {
                const response = await fetch(`/api/rides/${rideId}/reservations`);
                const reservations = await response.json();
                
                const passengersDiv = document.getElementById(`passengers-${rideId}`);
                
                if (reservations.length === 0) {
                    passengersDiv.innerHTML = '<div style="color: #666; font-style: italic;">üöï ≈Ω√°dn√≠ pasa≈æ√©≈ôi</div>';
                    return;
                }
                
                const passengersList = reservations.map(res => 
                    `<div style="margin: 5px 0; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #28a745;">
                        <strong>üë§ ${res.passenger_name}</strong> | üìû ${res.passenger_phone} | üé´ ${res.seats_reserved} m√≠sto
                        <button onclick="ratePassenger('${res.passenger_name}', ${rideId})" style="background: #ffc107; color: black; border: none; padding: 4px 8px; border-radius: 3px; margin-left: 10px; cursor: pointer; font-size: 11px;">‚≠ê Hodnotit</button>
                    </div>`
                ).join('');
                
                passengersDiv.innerHTML = `<div style="font-weight: bold; margin-bottom: 8px;">üë• Pasa≈æ√©≈ôi:</div>${passengersList}`;
                
            } catch (error) {
                const passengersDiv = document.getElementById(`passengers-${rideId}`);
                if (passengersDiv) {
                    passengersDiv.innerHTML = '<div style="color: #dc3545;">‚ùå Chyba p≈ôi naƒç√≠t√°n√≠</div>';
                }
            }
        }
        
        let currentRating = 0;
        let currentRatingData = {};
        
        function rateDriver(reservationId, driverName) {
            currentRatingData = {
                reservationId: reservationId,
                driverName: driverName,
                type: 'driver'
            };
            
            document.getElementById('ratingUserName').textContent = `Hodnotit ≈ôidiƒçe: ${driverName}`;
            document.getElementById('ratingComment').value = '';
            setRating(0);
            showSection('rating');
        }
        
        function setRating(rating) {
            currentRating = rating;
            
            for (let i = 1; i <= 5; i++) {
                const star = document.getElementById(`star${i}`);
                if (i <= rating) {
                    star.textContent = '‚òÖ'; // Pln√° hvƒõzdiƒçka
                    star.style.color = '#ffc107';
                } else {
                    star.textContent = '‚òÜ'; // Pr√°zdn√° hvƒõzdiƒçka
                    star.style.color = '#ddd';
                }
            }
        }
        
        async function submitRating() {
            if (currentRating === 0) {
                showMessage('Vyberte hodnocen√≠ (1-5 hvƒõzdiƒçek)', 'error');
                return;
            }
            
            const comment = document.getElementById('ratingComment').value.trim();
            
            try {
                let requestData = {
                    ride_id: currentRatingData.reservationId,
                    rater_id: currentUser.id,
                    rating: currentRating,
                    comment: comment
                };
                
                if (currentRatingData.type === 'driver') {
                    requestData.driver_name = currentRatingData.driverName;
                } else if (currentRatingData.type === 'passenger') {
                    requestData.rated_id = 0; // Bude se hledat podle jm√©na
                }
                
                const response = await fetch('/api/ratings/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const userType = currentRatingData.type === 'driver' ? '≈òidiƒç' : 'Pasa≈æ√©r';
                    showMessage(`${userType} √∫spƒõ≈°nƒõ ohodnocen!`);
                    showSection(currentRatingData.type === 'driver' ? 'reservations' : 'my-rides');
                } else {
                    showMessage(result.error || 'Chyba p≈ôi hodnocen√≠', 'error');
                }
            } catch (error) {
                showMessage('Chyba: ' + error.message, 'error');
            }
        }
        
        function ratePassenger(passengerName, rideId) {
            currentRatingData = {
                reservationId: rideId,
                passengerName: passengerName,
                type: 'passenger'
            };
            
            document.getElementById('ratingUserName').textContent = `Hodnotit pasa≈æ√©ra: ${passengerName}`;
            document.getElementById('ratingComment').value = '';
            setRating(0);
            showSection('rating');
        }
        
        async function showDriverReviews(driverName) {
            try {
                const response = await fetch(`/api/users/${encodeURIComponent(driverName)}/reviews`);
                const reviews = await response.json();
                
                if (reviews.length === 0) {
                    alert(`${driverName} zat√≠m nem√° ≈æ√°dn√© slovn√≠ hodnocen√≠.`);
                    return;
                }
                
                let reviewsText = `Recenze pro ${driverName}:\n\n`;
                
                reviews.forEach(review => {
                    const stars = '*'.repeat(review.rating);
                    const date = new Date(review.created_at).toLocaleDateString();
                    reviewsText += `${stars} (${review.rating}/5)\n`;
                    reviewsText += `"${review.comment}"\n`;
                    reviewsText += `- ${review.rater_name}, ${date}\n\n`;
                });
                
                alert(reviewsText);
                
            } catch (error) {
                alert('Chyba p≈ôi naƒç√≠t√°n√≠ recenz√≠: ' + error.message);
            }
        }
        
        // KONTROLA ULO≈ΩEN√âHO P≈òIHL√Å≈†EN√ç
        function checkSavedLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    if (currentUser) {
                        console.log('INIT v359: Starting notification check for saved user');
                        setTimeout(() => {
                            if (typeof startNotificationCheck === 'function') {
                                startNotificationCheck();
                            }
                        }, 2000);
                    }
                } catch (e) {
                    localStorage.removeItem('currentUser');
                }
            }
        }
        
        // Notification functions moved to script.js
        
        // Notification functions are now in script.js file
        
        // Fallback funkce pro vytvo≈ôen√≠ chat modalu
        function createChatModal(rideId, driverName) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; justify-content: center; align-items: center;';
            
            const chatBox = document.createElement('div');
            chatBox.style.cssText = 'background: white; width: 400px; height: 500px; border-radius: 10px; padding: 20px; position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.3);';
            
            chatBox.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>Chat s ${driverName}</h3>
                    <button onclick="this.closest('.modal-overlay').remove()" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">‚úï</button>
                </div>
                <div id="notifChatMessages" style="height: 350px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background: #f9f9f9;"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="notifChatInput" placeholder="Napi≈°te zpr√°vu..." style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" onkeypress="if(event.key==='Enter') sendNotifMessage(${rideId})">
                    <button onclick="sendNotifMessage(${rideId})" style="background: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Odeslat</button>
                </div>
            `;
            
            modal.className = 'modal-overlay';
            modal.appendChild(chatBox);
            document.body.appendChild(modal);
            
            loadNotifChatMessages(rideId);
            
            const interval = setInterval(() => loadNotifChatMessages(rideId), 3000);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    clearInterval(interval);
                    modal.remove();
                }
            });
        }
        
        async function sendNotifMessage(rideId) {
            const input = document.getElementById('notifChatInput');
            const message = input.value.trim();
            if (!message || !currentUser) return;
            
            try {
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ride_id: rideId,
                        sender_name: currentUser.name,
                        message: message
                    })
                });
                
                if (response.ok) {
                    input.value = '';
                    loadNotifChatMessages(rideId);
                }
            } catch (error) {
                console.error('Chyba p≈ôi odes√≠l√°n√≠:', error);
            }
        }
        
        async function loadNotifChatMessages(rideId) {
            try {
                const response = await fetch('/api/chat/' + rideId + '/messages');
                const messages = await response.json();
                
                const messagesDiv = document.getElementById('notifChatMessages');
                if (!messagesDiv) return;
                
                messagesDiv.innerHTML = '';
                
                messages.forEach(msg => {
                    const div = document.createElement('div');
                    const isMyMessage = msg.sender_name === currentUser.name;
                    div.style.cssText = `margin: 8px 0; padding: 8px; border-radius: 8px; ${isMyMessage ? 'background: #e3f2fd; text-align: right; margin-left: 50px;' : 'background: #f5f5f5; margin-right: 50px;'}`;
                    div.innerHTML = `<strong>${msg.sender_name}:</strong> ${msg.message}<br><small style="color: #666;">${new Date(msg.created_at).toLocaleString()}</small>`;
                    messagesDiv.appendChild(div);
                });
                
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ zpr√°v:', error);
            }
        }
        
        let isTracking = false;
        let trackingInterval = null;
        let userMarkers = {};
        let searchMap = null;
        let myLocationMarker = null;
        let searchRadius = null;
        let currentLocation = null;
        let autoLocationInterval = null;
        
        function updateRangeValue(value) {
            let actualRange;
            if (value == 0) {
                actualRange = 0;
            } else {
                // Logaritmick√° ≈°k√°la: 0-300 km
                actualRange = Math.round(Math.pow(value / 100 * 300, 1.5) / 10);
                if (actualRange < 1) actualRange = 1;
                if (actualRange > 300) actualRange = 300;
            }
            
            const rangeElement = document.getElementById('rangeValue');
            if (rangeElement) {
                rangeElement.textContent = actualRange;
            }
            
            if (searchMap && searchRadius) {
                searchMap.removeLayer(searchRadius);
                searchRadius = null;
            }
            
            if (searchMap && currentLocation && actualRange > 0) {
                searchRadius = L.circle([currentLocation.lat, currentLocation.lng], {
                    color: '#007bff',
                    fillColor: '#007bff',
                    fillOpacity: 0.1,
                    radius: actualRange * 1000
                }).addTo(searchMap);
            }
        }
        
        function initSearchMap() {
            if (searchMap) return;
            
            searchMap = L.map('searchMap').setView([49.75, 15.5], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(searchMap);
        }
        
        function autoUpdateLocation() {
            // Zkontroluj, zda u≈æ byl udƒõlen souhlas s GPS
            if (localStorage.getItem('gps_permission') === 'granted') {
                if (autoLocationInterval) {
                    clearInterval(autoLocationInterval);
                }
                
                // Okam≈æitƒõ naƒçti polohu
                updateLocationOnce();
                
                // Pak aktualizuj ka≈æd√Ωch 30 sekund
                autoLocationInterval = setInterval(updateLocationOnce, 30000);
            }
        }
        
        function updateLocationOnce() {
            if (!searchMap) {
                initSearchMap();
                setTimeout(updateLocationOnce, 500);
                return;
            }
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        currentLocation = { lat, lng };
                        
                        // Odstra≈à star√Ω marker a kruh
                        if (myLocationMarker) searchMap.removeLayer(myLocationMarker);
                        if (searchRadius) searchMap.removeLayer(searchRadius);
                        
                        // P≈ôidej marker m√© polohy
                        myLocationMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                html: '<div style="background: #007bff; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                                iconSize: [22, 22],
                                iconAnchor: [11, 11]
                            })
                        }).addTo(searchMap);
                        
                        // P≈ôidej kruh vzd√°lenosti
                        const rangeSlider = document.getElementById('searchRange').value;
                        if (rangeSlider > 0) {
                            const actualRange = Math.round(Math.pow(rangeSlider / 100 * 300, 1.5) / 10);
                            if (actualRange > 0) {
                                searchRadius = L.circle([lat, lng], {
                                    color: '#007bff',
                                    fillColor: '#007bff',
                                    fillOpacity: 0.1,
                                    radius: actualRange * 1000
                                }).addTo(searchMap);
                            }
                        }
                        
                        myLocationMarker.bindPopup('üìç Va≈°e aktu√°ln√≠ poloha (automaticky aktualizov√°no)');
                        
                        // Naƒçti a zobraz aktivn√≠ ≈ôidiƒçe
                        loadActiveDrivers();
                    },
                    (error) => {
                        console.log('GPS nedostupn√©:', error);
                    },
                    { enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 }
                );
            }
        }
        
        async function loadActiveDrivers() {
            try {
                const response = await fetch('/api/users/locations');
                const locations = await response.json();
                
                // Odstra≈à star√© markery ≈ôidiƒç≈Ø
                Object.keys(userMarkers).forEach(userId => {
                    if (userMarkers[userId] && searchMap.hasLayer(userMarkers[userId])) {
                        searchMap.removeLayer(userMarkers[userId]);
                    }
                });
                userMarkers = {};
                
                // P≈ôidej nov√© markery aktivn√≠ch ≈ôidiƒç≈Ø
                locations.forEach(loc => {
                    if (loc.user_id !== currentUser?.id) { // Nezobrazuj sebe
                        const marker = L.marker([loc.lat, loc.lng], {
                            icon: L.divIcon({
                                html: '<div style="background: #28a745; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">üöó</div>',
                                iconSize: [25, 25],
                                iconAnchor: [12, 12]
                            })
                        }).addTo(searchMap);
                        
                        marker.bindPopup(`
                            <div style="text-align: center;">
                                <h4>üöó ${loc.user_name}</h4>
                                <p>Aktivn√≠ ≈ôidiƒç</p>
                                <small>Aktualizov√°no: ${new Date(loc.updated_at).toLocaleTimeString()}</small>
                            </div>
                        `);
                        
                        userMarkers[loc.user_id] = marker;
                    }
                });
            } catch (error) {
                console.log('Nelze naƒç√≠st aktivn√≠ ≈ôidiƒçe:', error);
            }
        }
        
        function showMyLocation() {
            if (!searchMap) {
                initSearchMap();
                setTimeout(showMyLocation, 500);
                return;
            }
            
            if (navigator.geolocation) {
                showMessage('Z√≠sk√°v√°m GPS polohu...', 'info');
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        console.log('GPS poloha z√≠sk√°na:', lat, lng);
                        currentLocation = { lat, lng };
                        
                        // Odstra≈à star√Ω marker a kruh
                        if (myLocationMarker) searchMap.removeLayer(myLocationMarker);
                        if (searchRadius) searchMap.removeLayer(searchRadius);
                        
                        // P≈ôidej marker m√© polohy
                        myLocationMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                html: '<div style="background: #007bff; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); animation: pulse 2s infinite;"></div>',
                                iconSize: [26, 26],
                                iconAnchor: [13, 13]
                            })
                        }).addTo(searchMap);
                        
                        // P≈ôidej kruh vzd√°lenosti
                        const rangeSlider = document.getElementById('searchRange');
                        if (rangeSlider && rangeSlider.value > 0) {
                            const actualRange = Math.round(Math.pow(rangeSlider.value / 100 * 300, 1.5) / 10);
                            if (actualRange > 0) {
                                searchRadius = L.circle([lat, lng], {
                                    color: '#007bff',
                                    fillColor: '#007bff',
                                    fillOpacity: 0.1,
                                    radius: actualRange * 1000
                                }).addTo(searchMap);
                            }
                        }
                        
                        // Vycentruj mapu na moji polohu
                        searchMap.setView([lat, lng], 13);
                        
                        // Ulo≈æ souhlas s GPS pro budouc√≠ automatick√© sledov√°n√≠
                        localStorage.setItem('gps_permission', 'granted');
                        
                        myLocationMarker.bindPopup(`üìç Va≈°e aktu√°ln√≠ poloha<br>Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}`).openPopup();
                        showMessage('‚úÖ Poloha nalezena! GPS zapnuto.');
                        
                        // Spus≈• automatick√© sledov√°n√≠
                        autoUpdateLocation();
                    },
                    (error) => {
                        console.error('GPS chyba:', error);
                        let errorMsg = 'Nelze z√≠skat GPS polohu';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg = 'GPS p≈ô√≠stup zam√≠tnut. Povolte GPS v nastaven√≠ prohl√≠≈æeƒçe.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg = 'GPS poloha nen√≠ dostupn√°.';
                                break;
                            case error.TIMEOUT:
                                errorMsg = 'GPS timeout - zkuste to znovu.';
                                break;
                        }
                        
                        showMessage(errorMsg, 'error');
                    },
                    { 
                        enableHighAccuracy: true, 
                        timeout: 15000, 
                        maximumAge: 60000 
                    }
                );
            } else {
                showMessage('GPS nen√≠ v tomto prohl√≠≈æeƒçi podporov√°no', 'error');
            }
        }
        
        function startLocationTracking() {
            if (!currentUser) {
                showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                return;
            }
            
            if (isTracking) {
                stopLocationTracking();
                return;
            }
            
            if (navigator.geolocation) {
                isTracking = true;
                document.getElementById('trackingBtn').textContent = '‚èπÔ∏è Zastavit sd√≠len√≠';
                
                trackingInterval = setInterval(() => {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            
                            // Ulo≈æ polohu na server
                            fetch('/api/users/location', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    user_id: currentUser.id,
                                    lat: lat,
                                    lng: lng
                                })
                            });
                            
                            // Aktualizuj vlastn√≠ marker
                            updateUserMarker(currentUser.id, currentUser.name, lat, lng, true);
                        },
                        (error) => {
                            console.error('GPS chyba:', error);
                            stopLocationTracking();
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }
                    );
                }, 10000); // Aktualizace ka≈æd√Ωch 10 sekund
                
                showMessage('Sd√≠len√≠ polohy zapnuto');
            } else {
                showMessage('GPS nen√≠ podporov√°no', 'error');
            }
        }
        
        function stopLocationTracking() {
            isTracking = false;
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
            document.getElementById('trackingBtn').textContent = 'üìç Sd√≠let polohu';
            showMessage('Sd√≠len√≠ polohy vypnuto');
        }
        
        function updateUserMarker(userId, userName, lat, lng, isCurrentUser = false) {
            if (!map) return;
            
            // Odstra≈à star√Ω marker
            if (userMarkers[userId]) {
                map.removeLayer(userMarkers[userId]);
            }
            
            let marker;
            
            if (isCurrentUser) {
                // Vlastn√≠ poloha - modr√° teƒçka
                marker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: '<div style="background: #007bff; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                        iconSize: [22, 22],
                        iconAnchor: [11, 11]
                    })
                }).addTo(map);
            } else {
                // Ostatn√≠ u≈æivatel√© - zelen√Ω marker s autem
                marker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: '<div style="background: #28a745; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">üöó</div>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(map);
            }
            
            marker.bindPopup(`
                <div style="text-align: center;">
                    <h4>${userName}</h4>
                    <p>${isCurrentUser ? 'Va≈°e poloha' : 'Aktu√°ln√≠ poloha'}</p>
                    <small>${new Date().toLocaleTimeString()}</small>
                </div>
            `);
            
            userMarkers[userId] = marker;
        }
        
        async function showAllUserLocations() {
            try {
                const response = await fetch('/api/users/locations');
                const locations = await response.json();
                
                locations.forEach(loc => {
                    updateUserMarker(loc.user_id, loc.user_name, loc.lat, loc.lng, loc.user_id === currentUser?.id);
                });
                
                showMessage(`Zobrazeno ${locations.length} u≈æivatel≈Ø na mapƒõ`);
            } catch (error) {
                showMessage('Chyba p≈ôi naƒç√≠t√°n√≠ poloh', 'error');
            }
        }
        
        
        
        
        
        // FUNKCE PRO PR√ÅCI S U≈ΩIVATELI
        async function loadAllUsers() {
            const resultsDiv = document.getElementById('usersResults');
            resultsDiv.innerHTML = '‚è≥ Naƒç√≠t√°m nejlep≈°√≠ u≈æivatele...';
            
            try {
                const response = await fetch(`/api/users/all?user_id=${currentUser?.id || 0}`);
                const result = await response.json();
                
                if (!response.ok) {
                    resultsDiv.innerHTML = '‚ùå Chyba: ' + (result.error || 'Nezn√°m√° chyba');
                    return;
                }
                
                const users = Array.isArray(result) ? result : [];
                
                if (users.length === 0) {
                    resultsDiv.innerHTML = '<p style="text-align: center; color: #666;">‚ùå ≈Ω√°dn√≠ u≈æivatel√©</p>';
                    return;
                }
                
                resultsDiv.innerHTML = users.map(user => `
                    <div class="ride" style="cursor: pointer;" onclick="showUserProfile(${user.id})">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3>${user.name} ${user.verified ? '‚úì' : ''}</h3>
                                <div>‚≠ê ${(user.rating || 0).toFixed(1)} | üöó ${user.total_rides} j√≠zd | üë• ≈òidiƒç: ${user.rides_as_driver}x, Pasa≈æ√©r: ${user.rides_as_passenger}x</div>
                                <div style="font-size: 12px; color: #666;">Posledn√≠ aktivita: ${new Date(user.last_active).toLocaleDateString()}</div>
                            </div>
                            <div style="text-align: right;">
                                <button class="btn" onclick="event.stopPropagation(); addToFavorites(${user.id})" style="background: #ffc107; padding: 5px 10px; margin: 2px;">‚ù§Ô∏è</button>
                                <button class="btn" onclick="event.stopPropagation(); showUserProfile(${user.id})" style="padding: 5px 10px;">üëÅÔ∏è Profil</button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                resultsDiv.innerHTML = '‚ùå Chyba p≈ôi naƒç√≠t√°n√≠: ' + error.message;
            }
        }
        
        async function searchUsers() {
            const query = document.getElementById('userSearchQuery').value.trim();
            const verifiedOnly = document.getElementById('verifiedOnly').checked;
            const minRating = document.getElementById('minRatingFilter').value;
            const cityFilter = document.getElementById('cityFilter').value;
            
            if (!query && !cityFilter) {
                showMessage('Zadejte jm√©no nebo vyberte mƒõsto', 'error');
                return;
            }
            
            const resultsDiv = document.getElementById('usersResults');
            resultsDiv.innerHTML = '‚è≥ Vyhled√°v√°m u≈æivatele...';
            
            try {
                let url = `/api/users/search?q=${encodeURIComponent(query)}&user_id=${currentUser?.id || 0}`;
                if (verifiedOnly) url += '&verified=true';
                if (minRating) url += `&min_rating=${minRating}`;
                if (cityFilter) url += `&city=${encodeURIComponent(cityFilter)}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (!response.ok) {
                    resultsDiv.innerHTML = '‚ùå Chyba: ' + (result.error || 'Nezn√°m√° chyba');
                    return;
                }
                
                const users = Array.isArray(result) ? result : [];
                console.log('Nalezeni u≈æivatel√©:', users);
                
                if (users.length === 0) {
                    resultsDiv.innerHTML = '<p style="text-align: center; color: #666;">‚ùå ≈Ω√°dn√≠ u≈æivatel√© nenalezeni</p>';
                    return;
                }
                
                resultsDiv.innerHTML = users.map(user => `
                    <div class="ride" style="cursor: pointer;" onclick="showUserProfile(${user.id})">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3>${user.name} ${user.verified ? '‚úì' : ''}</h3>
                                <div>‚≠ê ${(user.rating || 0).toFixed(1)} | üöó ${user.total_rides} j√≠zd | üè† ${user.home_city || 'Nezn√°m√©'}</div>
                                <div style="font-size: 12px; color: #666;">Posledn√≠ aktivita: ${new Date(user.last_active).toLocaleDateString()}</div>
                            </div>
                            <div>
                                <button class="btn" onclick="event.stopPropagation(); addToFavorites(${user.id})" style="background: #ffc107; padding: 5px 10px;">‚ù§Ô∏è Obl√≠bit</button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                resultsDiv.innerHTML = '‚ùå Chyba p≈ôi vyhled√°v√°n√≠: ' + error.message;
            }
        }
        
        async function showUserProfile(userId) {
            document.getElementById('userProfileTitle').textContent = 'üë§ Profil u≈æivatele';
            const contentDiv = document.getElementById('userProfileContent');
            contentDiv.innerHTML = '‚è≥ Naƒç√≠t√°m profil...';
            
            showSection('user-profile');
            
            try {
                const response = await fetch(`/api/users/${userId}/profile`);
                const profile = await response.json();
                
                console.log('User profile data:', profile);

                document.getElementById('userProfileTitle').textContent = `üë§ ${profile.name}`;
                
                const reviewsHtml = (profile.reviews || []).length > 0 ?
                    (profile.reviews || []).map(review => `
                        <div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 3px solid #007bff;">
                            <div>‚≠ê ${review.rating}/5 - ${review.comment}</div>
                            <div style="font-size: 12px; color: #666;">od ${review.reviewer}, ${new Date(review.date).toLocaleDateString()}</div>
                        </div>
                    `).join('') : '<p style="color: #666;">Zat√≠m ≈æ√°dn√© recenze</p>';
                
                const historyHtml = (profile.recent_rides || []).length > 0 ?
                    (profile.recent_rides || []).map(ride => `
                        <div style="background: #f8f9fa; padding: 8px; margin: 3px 0; border-radius: 3px;">
                            <span style="background: ${ride.role === 'driver' ? '#28a745' : '#007bff'}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px;">${ride.role === 'driver' ? 'üöó ≈òidiƒç' : 'üë• Pasa≈æ√©r'}</span>
                            ${ride.from} ‚Üí ${ride.to} (${new Date(ride.date).toLocaleDateString()})
                        </div>
                    `).join('') : '<p style="color: #666;">Zat√≠m ≈æ√°dn√© j√≠zdy</p>';
                
                contentDiv.innerHTML = `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>${profile.name} ${profile.verified ? '‚úì Ovƒõ≈ôeno' : ''}</h3>
                            <div>
                                <button class="btn" onclick="addToFavorites(${profile.id})" style="background: #ffc107; margin-right: 10px;">‚ù§Ô∏è P≈ôidat do obl√≠ben√Ωch</button>
                                <button class="btn btn-danger" onclick="blockUser(${profile.id})">üö´ Blokovat</button>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #007bff;">${(profile.rating || 0).toFixed(1)}</div>
                                <div style="font-size: 12px; color: #666;">‚≠ê Hodnocen√≠</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${profile.total_rides}</div>
                                <div style="font-size: 12px; color: #666;">üöó Celkem j√≠zd</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">${profile.rides_as_driver}</div>
                                <div style="font-size: 12px; color: #666;">üöó Jako ≈ôidiƒç</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #6f42c1;">${profile.rides_as_passenger}</div>
                                <div style="font-size: 12px; color: #666;">üë• Jako pasa≈æ√©r</div>
                            </div>
                        </div>
                        
                        <div style="font-size: 12px; color: #666;">
                            üìÖ ƒålen od: ${new Date(profile.member_since).toLocaleDateString()}
                        </div>
                        
                        ${profile.bio ? `<div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px;"><strong>O mƒõ:</strong> ${profile.bio}</div>` : ''}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4>üí¨ Recenze (${(profile.reviews || []).length})</h4>
                        ${reviewsHtml}
                    </div>
                    
                    <div>
                        <h4>üìà Posledn√≠ j√≠zdy</h4>
                        ${historyHtml}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading user profile:', error);
                contentDiv.innerHTML = '‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ profilu: ' + error.message;
            }
        }
        
        async function addToFavorites(userId) {
            if (!currentUser) {
                showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/users/favorites', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        favorite_user_id: userId
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('U≈æivatel p≈ôid√°n do obl√≠ben√Ωch!');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage('Chyba: ' + error.message, 'error');
            }
        }
        
        async function blockUser(userId) {
            if (!currentUser) {
                showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                return;
            }
            
            if (!confirm('Opravdu chcete zablokovat tohoto u≈æivatele?')) {
                return;
            }
            
            const reason = prompt('D≈Øvod blokace (voliteln√©):') || '';
            
            try {
                const response = await fetch('/api/users/block', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        blocker_id: currentUser.id,
                        blocked_id: userId,
                        reason: reason
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('U≈æivatel zablokovan!');
                    showSection('users');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage('Chyba: ' + error.message, 'error');
            }
        }
        
        async function loadCompleteUserList() {
            const resultsDiv = document.getElementById('usersResults');
            resultsDiv.innerHTML = '‚è≥ Naƒç√≠t√°m kompletn√≠ seznam u≈æivatel≈Ø...';
            
            try {
                const response = await fetch(`/api/users/all?user_id=${currentUser?.id || 0}`);
                const result = await response.json();
                
                if (!response.ok) {
                    resultsDiv.innerHTML = '‚ùå Chyba: ' + (result.error || 'Nezn√°m√° chyba');
                    return;
                }
                
                const users = Array.isArray(result) ? result : [];
                
                if (users.length === 0) {
                    resultsDiv.innerHTML = '<p style="text-align: center; color: #666;">‚ùå ≈Ω√°dn√≠ u≈æivatel√©</p>';
                    return;
                }
                
                // Zobraz v≈°echny u≈æivatele bez omezen√≠
                resultsDiv.innerHTML = `
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                        <h4 style="margin: 0; color: #1976d2;">üìÑ Kompletn√≠ seznam u≈æivatel≈Ø (${users.length})</h4>
                        <p style="margin: 5px 0 0 0; font-size: 14px; color: #666;">Se≈ôazeno podle hodnocen√≠ a poƒçtu j√≠zd</p>
                    </div>
                ` + users.map((user, index) => `
                    <div class="ride" style="cursor: pointer; position: relative;" onclick="showUserProfile(${user.id})">
                        <div style="position: absolute; top: 10px; left: 10px; background: #1976d2; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">${index + 1}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-left: 40px;">
                            <div>
                                <h3>${user.name} ${user.verified ? '<span style="color: #4caf50;">‚úì</span>' : ''}</h3>
                                <div style="display: flex; gap: 15px; margin: 5px 0;">
                                    <span>‚≠ê ${(user.rating || 0).toFixed(1)}</span>
                                    <span>üöó ${user.total_rides} j√≠zd</span>
                                    <span>üè† ${user.home_city || 'Nezn√°m√©'}</span>
                                    <span>üë• ≈òidiƒç: ${user.rides_as_driver}x</span>
                                    <span>üë• Pasa≈æ√©r: ${user.rides_as_passenger}x</span>
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    üìÖ Posledn√≠ aktivita: ${user.last_active ? new Date(user.last_active).toLocaleDateString() : 'Nezn√°m√°'}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <button class="btn" onclick="event.stopPropagation(); addToFavorites(${user.id})" style="background: #ffc107; padding: 5px 10px; margin: 2px;">‚ù§Ô∏è</button>
                                <button class="btn" onclick="event.stopPropagation(); showUserProfile(${user.id})" style="padding: 5px 10px;">üëÅÔ∏è Profil</button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                showMessage(`Naƒçteno ${users.length} u≈æivatel≈Ø!`);
                
            } catch (error) {
                resultsDiv.innerHTML = '‚ùå Chyba p≈ôi naƒç√≠t√°n√≠: ' + error.message;
            }
        }
        
        // Naƒçten√≠ mƒõst do registraƒçn√≠ho formul√°≈ôe
        async function loadCities() {
            const citySelect = document.getElementById('regCity');
            const cityFilter = document.getElementById('cityFilter');
            const editCitySelect = document.getElementById('editCity');

            loadCitiesIntoSelect(citySelect);
            if (cityFilter) {
                loadCitiesIntoSelect(cityFilter, null, true);
            }
            if (editCitySelect) {
                loadCitiesIntoSelect(editCitySelect);
            }
        }
        
        function showEditProfile(userId) {
            // Pre-fill the form with existing data
            fetch(`/api/users/${userId}/profile`)
                .then(response => response.json())
                .then(profile => {
                    document.getElementById('editEmail').value = profile.email || '';
                    document.getElementById('editBio').value = profile.bio || '';
                    
                    const citySelect = document.getElementById('editCity');
                    // Make sure cities are loaded
                    if (citySelect.options.length <= 1) {
                        loadCitiesIntoSelect(citySelect, profile.home_city);
                    } else {
                        citySelect.value = profile.home_city;
                    }

                    showSection('edit-profile');
                });
        }

        async function updateProfile() {
            const userId = currentUser.id;
            const data = {
                email: document.getElementById('editEmail').value,
                home_city: document.getElementById('editCity').value,
                bio: document.getElementById('editBio').value
            };

            try {
                const response = await fetch(`/api/users/${userId}/profile`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('Profil √∫spƒõ≈°nƒõ aktualizov√°n!');
                    showUserProfile(userId);
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage('Chyba p≈ôi aktualizaci profilu: ' + error.message, 'error');
            }
        }

        function loadCitiesIntoSelect(selectElement, selectedCity, addAllOption = false) {
            const cities = [
                { name: 'Praha', region: 'Hlavn√≠ mƒõsto Praha' },
                { name: 'Brno', region: 'Jihomoravsk√Ω kraj' },
                { name: 'Ostrava', region: 'Moravskoslezsk√Ω kraj' },
                { name: 'Plze≈à', region: 'Plze≈àsk√Ω kraj' },
                { name: 'Liberec', region: 'Libereck√Ω kraj' },
                { name: 'Olomouc', region: 'Olomouck√Ω kraj' },
                { name: '√öst√≠ nad Labem', region: '√östeck√Ω kraj' },
                { name: 'Hradec Kr√°lov√©', region: 'Kr√°lov√©hradeck√Ω kraj' },
                { name: 'ƒåesk√© Budƒõjovice', region: 'Jihoƒçesk√Ω kraj' },
                { name: 'Pardubice', region: 'Pardubick√Ω kraj' }
            ];
            
            if (addAllOption) {
                selectElement.innerHTML = '<option value="">V≈°echna mƒõsta</option>';
            } else {
                selectElement.innerHTML = '<option value="">Vyberte mƒõsto...</option>';
            }
            
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city.name;
                option.textContent = `${city.name} (${city.region})`;
                if (city.name === selectedCity) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }

        // Funkce pro vymaz√°n√≠ filtr≈Ø data a ƒçasu
        function clearDateTimeFilters() {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('timeFrom').value = '';
            document.getElementById('timeTo').value = '';
            showMessage('Filtry data a ƒçasu vymaz√°ny');
        }
        
        // Inicializace
        document.addEventListener('DOMContentLoaded', function() {
            checkSavedLogin();
            updateUI();
            loadCities();
        });
        
        // Spus≈• kontrolu notifikac√≠
        setTimeout(() => {
            if (currentUser && typeof startNotificationCheck === 'function') {
                console.log('AUTO-START v359: Starting notification check for logged user');
                startNotificationCheck();
            } else {
                console.log('AUTO-START v359: No logged user or function not available, notification check not started');
            }
        }, 3000);
        
        // Spus≈• pravidelnou kontrolu notifikac√≠ ka≈æd√Ωch 10 sekund
        setInterval(() => {
            if (currentUser && typeof checkForNotifications === 'function') {
                checkForNotifications();
            }
        }, 10000);
        
        // Prvn√≠ kontrola po 3 sekund√°ch
        setTimeout(() => {
            if (currentUser && typeof checkForNotifications === 'function') {
                checkForNotifications();
            }
        }, 3000);
        
        
        
        // Inicializuj slider hodnotu
        setTimeout(() => {
            const slider = document.getElementById('searchRange');
            if (slider) {
                updateRangeValue(slider.value);
            }
        }, 100);
        
        // Funkce pro zobrazen√≠/skryt√≠ hesla
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Spoluj√≠zda</h1>
            <div class="nav">
                <button onclick="showSection('login')" id="loginBtn">P≈ôihl√°sit</button>
                <button onclick="showSection('register')" id="registerBtn">Registrovat</button>
                <button onclick="showSection('search')" class="active">Hledat j√≠zdu</button>
                <button onclick="showSection('offer')" id="offerBtn" style="display:none;">Nab√≠dnout j√≠zdu</button>
                <button onclick="showSection('my-rides')" id="myRidesBtn" style="display:none;">üöó Mnou nab√≠zen√© j√≠zdy</button>
                <button onclick="showSection('reservations')" id="reservationsBtn" style="display:none;">üé´ Moje rezervace j√≠zd</button>
                <button onclick="showSection('map');">üó∫Ô∏è Mapa j√≠zd</button>
                <button onclick="showSection('users')" id="usersBtn" style="display:none;">üë• U≈æivatel√©</button>
                <button onclick="logout()" id="logoutBtn" style="display:none;">Odhl√°sit</button>
            </div>
        </div>

        <div id="userInfo" class="user-info" style="display:none;"></div>
        <div id="message" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 999999; width: 100%; max-width: 400px; text-align: center;"></div>

        <!-- Hled√°n√≠ j√≠zd -->
        <div id="search" class="section active">
            <h2>Hledat j√≠zdy</h2>
            <form onsubmit="search(); return false;" class="search-form">
                <input type="text" id="from" placeholder="Odkud - mƒõsto (Praha, Brno, Ostrava...)" />
                <input type="text" id="fromStreet" placeholder="Odkud - ulice (voliteln√©)" />
                <input type="text" id="to" placeholder="Kam - mƒõsto (Praha, Brno, Ostrava...)" />
                <input type="text" id="toStreet" placeholder="Kam - ulice (voliteln√©)" />
                <div style="display: flex; gap: 10px; margin: 10px 0;">
                    <div style="flex: 1;">
                        <label>Datum od:</label>
                        <input type="date" id="dateFrom" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="flex: 1;">
                        <label>Datum do:</label>
                        <input type="date" id="dateTo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="flex: 1;">
                        <label>ƒåas od:</label>
                        <input type="time" id="timeFrom" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="flex: 1;">
                        <label>ƒåas do:</label>
                        <input type="time" id="timeTo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                <div style="margin: 10px 0;">
                    <label>Vzd√°lenost od m√© polohy: <span id="rangeValue">50</span> km</label><br>
                    <input type="range" id="searchRange" min="0" max="100" value="50" oninput="updateRangeValue(this.value)" style="width: 100%; margin: 5px 0;">
                </div>
                <button type="submit" class="btn">üîç Hledat j√≠zdy v zadan√©m okol√≠</button>
                <button type="button" class="btn btn-success" onclick="showAll()">üìã V≈°echny j√≠zdy</button>
                <button type="button" class="btn" onclick="clearDateTimeFilters()" style="background: #6c757d;">üóëÔ∏è Vymazat filtry</button>
                <button type="button" class="btn" onclick="showMyLocation()" style="background: #17a2b8;">üìç Moje poloha</button>
                <button type="button" class="btn" onclick="showMyLocation()" style="background: #28a745;">üß™ Test GPS</button>

            </form>
            
            
            
            <!-- MAPA PRO VYHLED√ÅV√ÅN√ç -->
            <div id="searchMap" style="width: 100%; height: 300px; border: 2px solid #ddd; border-radius: 8px; margin: 15px 0;"></div>

            <div id="searchResults"></div>
        </div>

        <!-- P≈òIHL√Å≈†EN√ç -->
        <div id="login" class="section">
            <h2>P≈ôihl√°≈°en√≠</h2>
            <div class="form-group">
                <label>Telefon nebo email:</label>
                <input type="text" id="loginPhone" placeholder="+420123456789 nebo email@example.com" onkeypress="if(event.key==='Enter') login()" />
            </div>
            <div class="form-group">
                <label>Heslo:</label>
                <div style="position: relative;">
                    <input type="password" id="loginPassword" onkeypress="if(event.key==='Enter') login()" style="padding-right: 40px;" />
                    <button type="button" onclick="togglePassword('loginPassword')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 16px;">üëÅÔ∏è</button>
                </div>
            </div>
            <button class="btn" onclick="login()">P≈ôihl√°sit se</button>
        </div>

        <!-- REGISTRACE -->
        <div id="register" class="section">
            <h2>Registrace</h2>
            <div class="form-group">
                <label>Jm√©no:</label>
                <input type="text" id="regName" placeholder="Jan Nov√°k" onkeypress="if(event.key==='Enter') register()" />
            </div>
            <div class="form-group">
                <label>Telefon:</label>
                <input type="text" id="regPhone" placeholder="+420123456789" onkeypress="if(event.key==='Enter') register()" />
            </div>
            <div class="form-group">
                <label>Email (voliteln√Ω):</label>
                <input type="email" id="regEmail" placeholder="jan@example.com" onkeypress="if(event.key==='Enter') register()" />
            </div>
            <div class="form-group">
                <label>Mƒõsto bydli≈°tƒõ:</label>
                <select id="regCity" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
                    <option value="">Vyberte mƒõsto...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Heslo:</label>
                <div style="position: relative;">
                    <input type="password" id="regPassword" onkeypress="if(event.key==='Enter') register()" style="padding-right: 40px;" />
                    <button type="button" onclick="togglePassword('regPassword')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 16px;">üëÅÔ∏è</button>
                </div>
            </div>
            <div class="form-group">
                <label>Potvrzen√≠ hesla:</label>
                <div style="position: relative;">
                    <input type="password" id="regPasswordConfirm" onkeypress="if(event.key==='Enter') register()" style="padding-right: 40px;" />
                    <button type="button" onclick="togglePassword('regPasswordConfirm')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 16px;">üëÅÔ∏è</button>
                </div>
            </div>
            <div class="form-group">
                <label>PayPal email (pro ≈ôidiƒçe - voliteln√©):</label>
                <input type="email" id="regPaypalEmail" placeholder="paypal@example.com" />
                <small style="color: #666; font-size: 12px;">Pokud chcete p≈ôij√≠mat platby online, zadejte v√°≈° PayPal email</small>
            </div>
            <div style="margin: 15px 0; font-size: 12px; color: #666;">
                <label><input type="checkbox" id="agreeTerms" required> Souhlas√≠m s <a href="/terms" target="_blank">obchodn√≠mi podm√≠nkami</a></label><br>
                <label><input type="checkbox" id="agreePrivacy" required> Souhlas√≠m se <a href="/privacy" target="_blank">zpracov√°n√≠m osobn√≠ch √∫daj≈Ø</a></label>
            </div>
            <button type="button" class="btn" onclick="register()">Registrovat se</button>
        </div>

        <!-- MAPA J√çZD -->
        <div id="map" class="section">
            <h2>üó∫Ô∏è Mapa j√≠zd</h2>
            <div id="realMap" style="width: 100%; height: 500px; border: 2px solid #ddd; border-radius: 8px;"></div>
            
            <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;" id="mapRidesList">
                <!-- J√≠zdy se naƒçtou zde -->
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #dee2e6;">
                <h4 style="margin: 0 0 10px 0; color: #495057;">üó∫Ô∏è Legenda mapy:</h4>
                <div style="display: flex; gap: 20px; flex-wrap: wrap; font-size: 14px;">
                    <div><span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 10px; font-weight: bold; margin-right: 8px; font-size: 10px;">START</span>Odkud jede auto</div>
                    <div><span style="background: #f44336; color: white; padding: 2px 6px; border-radius: 10px; font-weight: bold; margin-right: 8px; font-size: 10px;">C√çL</span>Kam jede auto</div>
                    <div><span style="color: #2196f3; font-weight: bold; margin-right: 8px;">‚Äî</span>Trasa mezi mƒõsty</div>
                </div>
            </div>
            <button class="btn" style="margin-top: 15px;" onclick="loadMapRides()">üîÑ Naƒç√≠st j√≠zdy</button>
            <button class="btn" onclick="startLocationTracking()" id="trackingBtn" style="margin-top: 15px; margin-left: 10px;">üìç Sd√≠let polohu</button>
            <button class="btn" onclick="showAllUserLocations()" style="margin-top: 15px; margin-left: 10px;">üë• Zobrazit u≈æivatele</button>
        </div>

        <!-- REZERVAVOVAN√â J√çZDY -->
        <div id="reservations" class="section">
            <h2>üé´ Moje rezervace</h2>
            <div id="reservationsList">
                <p>Naƒç√≠t√°m va≈°e rezervace...</p>
            </div>
            <button class="btn" onclick="loadReservations()" style="margin-top: 15px;">üîÑ Aktualizovat</button>
        </div>

        <!-- MOJE J√çZDY (PRO ≈òIDIƒåE) -->
        <div id="my-rides" class="section">
            <h2>üöó Moje j√≠zdy</h2>
            <div id="myRidesList">
                <p>Naƒç√≠t√°m va≈°e j√≠zdy...</p>
            </div>
            <button class="btn" onclick="loadMyRides()" style="margin-top: 15px;">üîÑ Aktualizovat</button>
        </div>

        <!-- CHAT -->
        <div id="chat" class="section">
            <h2 id="chatTitle">üí¨ Chat</h2>
            <div id="chatMessages" style="height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; margin: 15px 0; background: #f9f9f9;">
                <p style="text-align: center; color: #666;">Vyberte chat...</p>
            </div>
            <div id="chatInput" style="display: none;">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="messageInput" placeholder="Napi≈°te zpr√°vu..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="btn" onclick="sendMessage()">üì® Odeslat</button>
                </div>
            </div>
        </div>

        <!-- HODNOCEN√ç -->
        <div id="rating" class="section">
            <h2 id="ratingTitle">‚≠ê Hodnocen√≠</h2>
            <div id="ratingContent" style="text-align: center; padding: 30px;">
                <h3 id="ratingUserName">Hodnotit u≈æivatele</h3>
                <div style="margin: 20px 0;">
                    <span style="font-size: 40px; cursor: pointer; margin: 0 5px;" onclick="setRating(1)" id="star1">‚òÜ</span>
                    <span style="font-size: 40px; cursor: pointer; margin: 0 5px;" onclick="setRating(2)" id="star2">‚òÜ</span>
                    <span style="font-size: 40px; cursor: pointer; margin: 0 5px;" onclick="setRating(3)" id="star3">‚òÜ</span>
                    <span style="font-size: 40px; cursor: pointer; margin: 0 5px;" onclick="setRating(4)" id="star4">‚òÜ</span>
                    <span style="font-size: 40px; cursor: pointer; margin: 0 5px;" onclick="setRating(5)" id="star5">‚òÜ</span>
                </div>
                <div style="margin: 20px 0;">
                    <textarea id="ratingComment" placeholder="Koment√°≈ô (voliteln√Ω)..." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                </div>
                <div>
                    <button class="btn btn-success" onclick="submitRating()">‚≠ê Odeslat hodnocen√≠</button>
                    <button class="btn" onclick="showSection('reservations')" style="margin-left: 10px;">‚ùå Zru≈°it</button>
                </div>
            </div>
        </div>

        <!-- SEZNAM U≈ΩIVATEL≈Æ -->
        <div id="users" class="section">
            <h2>üë• U≈æivatel√©</h2>
            
            <!-- VYHLED√ÅV√ÅN√ç U≈ΩIVATEL≈Æ -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="userSearchQuery" placeholder="Hledat u≈æivatele podle jm√©na..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <button class="btn" onclick="searchUsers()">üîç Hledat</button>
                </div>
                
                <div style="display: flex; gap: 15px; align-items: center; font-size: 14px;">
                    <label><input type="checkbox" id="verifiedOnly"> Pouze ovƒõ≈ôen√≠ ‚úì</label>
                    <label>Min. hodnocen√≠: 
                        <select id="minRatingFilter" style="padding: 5px;">
                            <option value="">V≈°echna</option>
                            <option value="4.5">4.5+ ‚≠ê</option>
                            <option value="4.0">4.0+ ‚≠ê</option>
                            <option value="3.5">3.5+ ‚≠ê</option>
                        </select>
                    </label>
                    <label>Mƒõsto: 
                        <select id="cityFilter" style="padding: 5px;">
                            <option value="">V≈°echna mƒõsta</option>
                        </select>
                    </label>
                    <button class="btn" onclick="loadAllUsers()" style="background: #28a745;">üìä Top u≈æivatel√©</button>
                    <button class="btn" onclick="loadCompleteUserList()" style="background: #17a2b8;">üìÑ V≈°ichni u≈æivatel√©</button>
                </div>
            </div>
            
            <!-- V√ùSLEDKY -->
            <div id="usersResults">
                <p style="text-align: center; color: #666;">Pou≈æijte vyhled√°v√°n√≠ nebo kliknƒõte na "Top u≈æivatel√©"</p>
            </div>
        </div>
        
        <!-- PROFIL U≈ΩIVATELE -->
        <div id="user-profile" class="section">
            <h2 id="userProfileTitle">üë§ Profil u≈æivatele</h2>
            <button class="btn" onclick="showSection('users')" style="margin-bottom: 20px;">‚Üê Zpƒõt na seznam</button>
            
            <div id="userProfileContent">
                <p>Naƒç√≠t√°m profil...</p>
            </div>
        </div>

        <!-- EDIT PROFILE -->
        <div id="edit-profile" class="section">
            <h2>Upravit profil</h2>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="editEmail" placeholder="jan@example.com" />
            </div>
            <div class="form-group">
                <label>Domovsk√© mƒõsto:</label>
                <select id="editCity" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
                    <option value="">Vyberte mƒõsto...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Bio:</label>
                <textarea id="editBio" placeholder="Nƒõco o sobƒõ..." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
            </div>
            <button class="btn btn-success" onclick="updateProfile()">Ulo≈æit zmƒõny</button>
            <button class="btn" onclick="showSection('user-profile')">Zru≈°it</button>
        </div>

        <!-- NAB√çDKA J√çZDY -->
        <div id="offer" class="section">
            <h2>Nab√≠dnout j√≠zdu</h2>
            <div class="form-group">
                <label>Odkud - mƒõsto:</label>
                <input type="text" id="offerFrom" placeholder="Praha, Brno, Ostrava..." onkeypress="if(event.key==='Enter') offerRide()" />
            </div>
            <div class="form-group">
                <label>Odkud - ulice (voliteln√©):</label>
                <input type="text" id="offerFromStreet" placeholder="N√°mƒõst√≠ M√≠ru, Hlavn√≠ n√°dra≈æ√≠..." onkeypress="if(event.key==='Enter') offerRide()" />
            </div>
            <div class="form-group">
                <label>Kam - mƒõsto:</label>
                <input type="text" id="offerTo" placeholder="Praha, Brno, Ostrava..." onkeypress="if(event.key==='Enter') offerRide()" />
            </div>
            <div class="form-group">
                <label>Kam - ulice (voliteln√©):</label>
                <input type="text" id="offerToStreet" placeholder="N√°mƒõst√≠ M√≠ru, Hlavn√≠ n√°dra≈æ√≠..." onkeypress="if(event.key==='Enter') offerRide()" />
            </div>
            <div class="form-group">
                <label>Datum a ƒças odjezdu:</label>
                <input type="datetime-local" id="offerTime" />
            </div>
            <div class="form-group">
                <label>Poƒçet voln√Ωch m√≠st:</label>
                <select id="offerSeats">
                    <option value="1">1 m√≠sto</option>
                    <option value="2">2 m√≠sta</option>
                    <option value="3">3 m√≠sta</option>
                    <option value="4">4 m√≠sta</option>
                </select>
            </div>
            <div class="form-group">
                <label>Cena za osobu (Kƒç):</label>
                <input type="number" id="offerPrice" placeholder="Cena za osobu" onkeypress="if(event.key==='Enter') offerRide()" />
            </div>
            <button class="btn btn-success" onclick="offerRide()">üöó Nab√≠dnout j√≠zdu</button>
        </div>
        <!-- FOOTER S PR√ÅVN√çMI INFORMACEMI -->
        <footer style="margin-top: 50px; padding: 20px 0; border-top: 1px solid #ddd; text-align: center; font-size: 12px; color: #666;">
            <div style="margin-bottom: 10px;">
                <a href="/terms" target="_blank" style="color: #007bff; text-decoration: none; margin: 0 10px;">Obchodn√≠ podm√≠nky</a> |
                <a href="/privacy" target="_blank" style="color: #007bff; text-decoration: none; margin: 0 10px;">Ochrana osobn√≠ch √∫daj≈Ø</a> |
                <a href="mailto:m.zeleny@volny.cz" style="color: #007bff; text-decoration: none; margin: 0 10px;">Kontakt</a>
            </div>
            <div>
                ¬© 2024 Sveztese.cz - Aplikace pro sd√≠len√≠ j√≠zd | Iƒå: 05402361
            </div>
        </footer>
    </div>

    

    <!-- PLOVOUC√ç CHAT OKNO -->
    <div id="floatingChat" style="display: none; position: fixed; top: 20px; left: 20px; width: 350px; height: 400px; background: white; border: 2px solid #007bff; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 1000;">
        <div style="background: #007bff; color: white; padding: 10px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <span id="floatingChatTitle">üí¨ Chat</span>
            <button onclick="closeFloatingChat()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer;">√ó</button>
        </div>
        <div id="floatingChatMessages" style="height: 280px; overflow-y: auto; padding: 10px; background: #f9f9f9;">
            <p style="text-align: center; color: #666;">Naƒç√≠t√°m zpr√°vy...</p>
        </div>
        <div style="padding: 10px; border-top: 1px solid #ddd;">
            <div style="display: flex; gap: 5px;">
                <input type="text" id="floatingMessageInput" placeholder="Zpr√°va..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" onkeypress="if(event.key==='Enter') sendFloatingMessage()" autofocus>
                <button onclick="sendFloatingMessage()" style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">üì®</button>
            </div>
        </div>
    </div>


    
</body>
</html>