<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spoluj√≠zda Enhanced</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: #2196F3; color: white; padding: 20px; text-align: center; }
        .nav { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
        .nav button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; background: #4CAF50; color: white; }
        .nav button:hover { background: #45a049; }
        .section { background: white; margin: 20px 0; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .btn { padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn:hover { opacity: 0.9; }
        .ride-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; background: #f9f9f9; }
        .ride-card h3 { color: #2196F3; margin-bottom: 10px; }
        .ride-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .filter-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .rating { color: #ff9800; }
        .verified { color: #4CAF50; font-weight: bold; }
        .hidden { display: none; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px; border-radius: 5px; color: white; z-index: 1000; }
        .notification.success { background: #4CAF50; }
        .notification.error { background: #f44336; }
        .chat-window { position: fixed; bottom: 20px; right: 20px; width: 300px; height: 400px; background: white; border: 1px solid #ddd; border-radius: 10px; display: none; z-index: 1000; }
        .chat-header { background: #2196F3; color: white; padding: 10px; border-radius: 10px 10px 0 0; }
        .chat-messages { height: 300px; overflow-y: auto; padding: 10px; }
        .chat-input { display: flex; padding: 10px; }
        .chat-input input { flex: 1; margin-right: 10px; }
        @media (max-width: 768px) {
            .nav { flex-direction: column; align-items: center; }
            .filter-section { grid-template-columns: 1fr; }
            .ride-info { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöó Spoluj√≠zda Enhanced</h1>
        <p>Pokroƒçil√° aplikace pro sd√≠len√≠ j√≠zd</p>
    </div>

    <div class="container">
        <div class="nav">
            <button onclick="showSection('login')">P≈ôihl√°≈°en√≠</button>
            <button onclick="showSection('register')">Registrace</button>
            <button onclick="showSection('search')">Hledat j√≠zdy</button>
            <button onclick="showSection('offer')">Nab√≠dnout j√≠zdu</button>
            <button onclick="showSection('profile')">Profil</button>
            <button onclick="showSection('favorites')">Obl√≠ben√©</button>
        </div>

        <!-- Login Section -->
        <div id="login-section" class="section">
            <h2>P≈ôihl√°≈°en√≠</h2>
            <div class="form-group">
                <label>Telefon/Email:</label>
                <input type="text" id="login-phone" placeholder="+420123456789">
            </div>
            <div class="form-group">
                <label>Heslo:</label>
                <input type="password" id="login-password">
            </div>
            <button class="btn btn-primary" onclick="login()">P≈ôihl√°sit se</button>
        </div>

        <!-- Register Section -->
        <div id="register-section" class="section hidden">
            <h2>Registrace</h2>
            <div class="form-group">
                <label>Jm√©no a p≈ô√≠jmen√≠:</label>
                <input type="text" id="register-name" placeholder="Jan Nov√°k">
            </div>
            <div class="form-group">
                <label>Telefon:</label>
                <input type="text" id="register-phone" placeholder="+420123456789">
            </div>
            <div class="form-group">
                <label>Email (voliteln√Ω):</label>
                <input type="email" id="register-email" placeholder="jan@example.com">
            </div>
            <div class="form-group">
                <label>Heslo:</label>
                <input type="password" id="register-password">
            </div>
            <div class="form-group">
                <label>Potvrzen√≠ hesla:</label>
                <input type="password" id="register-password-confirm">
            </div>
            <button class="btn btn-success" onclick="register()">Registrovat se</button>
        </div>

        <!-- Search Section -->
        <div id="search-section" class="section hidden">
            <h2>Hledat j√≠zdy</h2>
            <div class="filter-section">
                <div class="form-group">
                    <label>Odkud:</label>
                    <input type="text" id="search-from" placeholder="Praha">
                </div>
                <div class="form-group">
                    <label>Kam:</label>
                    <input type="text" id="search-to" placeholder="Brno">
                </div>
                <div class="form-group">
                    <label>Datum od:</label>
                    <input type="date" id="search-date-from">
                </div>
                <div class="form-group">
                    <label>Datum do:</label>
                    <input type="date" id="search-date-to">
                </div>
                <div class="form-group">
                    <label>Max. cena:</label>
                    <input type="number" id="search-max-price" placeholder="500">
                </div>
                <div class="form-group">
                    <label>Min. hodnocen√≠:</label>
                    <select id="search-min-rating">
                        <option value="">Jak√©koli</option>
                        <option value="4.5">4.5+</option>
                        <option value="4.0">4.0+</option>
                        <option value="3.5">3.5+</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="search-smoking"> Kou≈ôen√≠ povoleno
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="search-pets"> Dom√°c√≠ zv√≠≈ôata povolena
                    </label>
                </div>
            </div>
            <button class="btn btn-primary" onclick="searchRides()">Hledat</button>
            <div id="search-results"></div>
        </div>

        <!-- Offer Ride Section -->
        <div id="offer-section" class="section hidden">
            <h2>Nab√≠dnout j√≠zdu</h2>
            <div class="form-group">
                <label>Odkud:</label>
                <input type="text" id="offer-from" placeholder="Praha, V√°clavsk√© n√°mƒõst√≠">
            </div>
            <div class="form-group">
                <label>Kam:</label>
                <input type="text" id="offer-to" placeholder="Brno, hlavn√≠ n√°dra≈æ√≠">
            </div>
            <div class="form-group">
                <label>Datum a ƒças odjezdu:</label>
                <input type="datetime-local" id="offer-datetime">
            </div>
            <div class="form-group">
                <label>Poƒçet voln√Ωch m√≠st:</label>
                <input type="number" id="offer-seats" min="1" max="8" value="3">
            </div>
            <div class="form-group">
                <label>Cena za osobu (Kƒç):</label>
                <input type="number" id="offer-price" placeholder="300">
            </div>
            <div class="form-group">
                <label>Model auta:</label>
                <input type="text" id="offer-car-model" placeholder="≈†koda Octavia">
            </div>
            <div class="form-group">
                <label>Barva auta:</label>
                <input type="text" id="offer-car-color" placeholder="Modr√°">
            </div>
            <div class="form-group">
                <label>Popis j√≠zdy:</label>
                <textarea id="offer-description" placeholder="Dal≈°√≠ informace o j√≠zdƒõ..."></textarea>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="offer-smoking"> Kou≈ôen√≠ povoleno
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="offer-pets"> Dom√°c√≠ zv√≠≈ôata povolena
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="offer-recurring"> Opakuj√≠c√≠ se j√≠zda
                </label>
            </div>
            <button class="btn btn-success" onclick="offerRide()">Nab√≠dnout j√≠zdu</button>
        </div>

        <!-- Profile Section -->
        <div id="profile-section" class="section hidden">
            <h2>M≈Øj profil</h2>
            <div id="profile-info">
                <p>P≈ôihlaste se pro zobrazen√≠ profilu</p>
            </div>
            <div id="profile-verification" class="hidden">
                <h3>Ovƒõ≈ôen√≠</h3>
                <div class="form-group">
                    <label>Ovƒõ≈ôovac√≠ k√≥d SMS:</label>
                    <input type="text" id="verify-code" placeholder="123456">
                    <button class="btn btn-primary" onclick="verifyPhone()">Ovƒõ≈ôit telefon</button>
                </div>
            </div>
        </div>

        <!-- Favorites Section -->
        <div id="favorites-section" class="section hidden">
            <h2>Obl√≠ben√© trasy</h2>
            <div class="form-group">
                <label>N√°zev trasy:</label>
                <input type="text" id="fav-name" placeholder="Dom≈Ø z pr√°ce">
            </div>
            <div class="form-group">
                <label>Odkud:</label>
                <input type="text" id="fav-from" placeholder="Praha">
            </div>
            <div class="form-group">
                <label>Kam:</label>
                <input type="text" id="fav-to" placeholder="Brno">
            </div>
            <button class="btn btn-success" onclick="addFavorite()">P≈ôidat obl√≠benou</button>
            <div id="favorites-list"></div>
        </div>
    </div>

    <!-- Chat Window -->
    <div id="chat-window" class="chat-window">
        <div class="chat-header">
            <span id="chat-title">Chat</span>
            <button style="float: right; background: none; border: none; color: white; cursor: pointer;" onclick="closeChat()">√ó</button>
        </div>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="chat-input">
            <input type="text" id="chat-input" placeholder="Napi≈°te zpr√°vu...">
            <button class="btn btn-primary" onclick="sendMessage()">Odeslat</button>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentChatRide = null;

        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(sectionName + '-section').classList.remove('hidden');
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        async function register() {
            const data = {
                name: document.getElementById('register-name').value,
                phone: document.getElementById('register-phone').value,
                email: document.getElementById('register-email').value,
                password: document.getElementById('register-password').value,
                password_confirm: document.getElementById('register-password-confirm').value
            };

            try {
                const response = await fetch('/api/users/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (response.ok) {
                    showNotification('Registrace √∫spƒõ≈°n√°!');
                    showSection('login');
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                showNotification('Chyba p≈ôi registraci', 'error');
            }
        }

        async function login() {
            const data = {
                phone: document.getElementById('login-phone').value,
                password: document.getElementById('login-password').value
            };

            try {
                const response = await fetch('/api/users/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (response.ok) {
                    currentUser = result;
                    showNotification('P≈ôihl√°≈°en√≠ √∫spƒõ≈°n√©!');
                    updateProfileInfo();
                    showSection('search');
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                showNotification('Chyba p≈ôi p≈ôihl√°≈°en√≠', 'error');
            }
        }

        function updateProfileInfo() {
            if (!currentUser) return;
            
            const profileInfo = document.getElementById('profile-info');
            profileInfo.innerHTML = `
                <h3>${currentUser.name}</h3>
                <p>Hodnocen√≠: <span class="rating">${'‚òÖ'.repeat(Math.floor(currentUser.rating))} ${currentUser.rating.toFixed(1)}</span></p>
                <p>Telefon ovƒõ≈ôen: ${currentUser.phone_verified ? '<span class="verified">‚úì Ano</span>' : '‚ùå Ne'}</p>
                <p>Identita ovƒõ≈ôena: ${currentUser.id_verified ? '<span class="verified">‚úì Ano</span>' : '‚ùå Ne'}</p>
            `;
            
            if (!currentUser.phone_verified) {
                document.getElementById('profile-verification').classList.remove('hidden');
            }
        }

        async function verifyPhone() {
            const code = document.getElementById('verify-code').value;
            
            try {
                const response = await fetch(`/api/users/${currentUser.user_id}/verify-phone`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code})
                });

                const result = await response.json();
                if (response.ok) {
                    showNotification('Telefon ovƒõ≈ôen!');
                    currentUser.phone_verified = true;
                    updateProfileInfo();
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                showNotification('Chyba p≈ôi ovƒõ≈ôov√°n√≠', 'error');
            }
        }

        async function offerRide() {
            if (!currentUser) {
                showNotification('P≈ôihlaste se pros√≠m', 'error');
                return;
            }

            const data = {
                user_id: currentUser.user_id,
                from_location: document.getElementById('offer-from').value,
                to_location: document.getElementById('offer-to').value,
                departure_time: document.getElementById('offer-datetime').value,
                available_seats: parseInt(document.getElementById('offer-seats').value),
                price: parseFloat(document.getElementById('offer-price').value),
                car_model: document.getElementById('offer-car-model').value,
                car_color: document.getElementById('offer-car-color').value,
                description: document.getElementById('offer-description').value,
                smoking_allowed: document.getElementById('offer-smoking').checked,
                pets_allowed: document.getElementById('offer-pets').checked,
                recurring: document.getElementById('offer-recurring').checked
            };

            try {
                const response = await fetch('/api/rides/offer', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (response.ok) {
                    showNotification('J√≠zda nab√≠dnuta!');
                    document.getElementById('offer-section').querySelectorAll('input, textarea').forEach(input => input.value = '');
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                showNotification('Chyba p≈ôi nab√≠zen√≠ j√≠zdy', 'error');
            }
        }

        async function searchRides() {
            const params = new URLSearchParams({
                from: document.getElementById('search-from').value,
                to: document.getElementById('search-to').value,
                date_from: document.getElementById('search-date-from').value,
                date_to: document.getElementById('search-date-to').value,
                max_price: document.getElementById('search-max-price').value,
                min_rating: document.getElementById('search-min-rating').value,
                smoking_allowed: document.getElementById('search-smoking').checked,
                pets_allowed: document.getElementById('search-pets').checked
            });

            try {
                const response = await fetch(`/api/rides/search?${params}`);
                const rides = await response.json();
                
                const resultsDiv = document.getElementById('search-results');
                resultsDiv.innerHTML = '<h3>V√Ωsledky hled√°n√≠:</h3>';
                
                if (rides.length === 0) {
                    resultsDiv.innerHTML += '<p>≈Ω√°dn√© j√≠zdy nenalezeny.</p>';
                    return;
                }

                rides.forEach(ride => {
                    const rideCard = document.createElement('div');
                    rideCard.className = 'ride-card';
                    rideCard.innerHTML = `
                        <h3>${ride.from_location} ‚Üí ${ride.to_location}</h3>
                        <div class="ride-info">
                            <p><strong>≈òidiƒç:</strong> ${ride.driver_name} ${ride.driver_verified ? '<span class="verified">‚úì</span>' : ''}</p>
                            <p><strong>Hodnocen√≠:</strong> <span class="rating">${'‚òÖ'.repeat(Math.floor(ride.driver_rating))} ${ride.driver_rating.toFixed(1)}</span></p>
                            <p><strong>Odjezd:</strong> ${new Date(ride.departure_time).toLocaleString('cs-CZ')}</p>
                            <p><strong>Voln√° m√≠sta:</strong> ${ride.available_seats}</p>
                            <p><strong>Cena:</strong> ${ride.price} Kƒç</p>
                            <p><strong>Auto:</strong> ${ride.car_model} (${ride.car_color})</p>
                            <p><strong>Kou≈ôen√≠:</strong> ${ride.smoking_allowed ? 'Povoleno' : 'Zak√°z√°no'}</p>
                            <p><strong>Zv√≠≈ôata:</strong> ${ride.pets_allowed ? 'Povolena' : 'Zak√°z√°na'}</p>
                        </div>
                        <p><strong>Popis:</strong> ${ride.description}</p>
                        <button class="btn btn-success" onclick="bookRide(${ride.id})">Rezervovat</button>
                        <button class="btn btn-primary" onclick="openChat(${ride.id}, '${ride.driver_name}')">Chat</button>
                    `;
                    resultsDiv.appendChild(rideCard);
                });
            } catch (error) {
                showNotification('Chyba p≈ôi hled√°n√≠ j√≠zd', 'error');
            }
        }

        async function bookRide(rideId) {
            if (!currentUser) {
                showNotification('P≈ôihlaste se pros√≠m', 'error');
                return;
            }

            try {
                const response = await fetch('/api/bookings/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ride_id: rideId,
                        passenger_id: currentUser.user_id,
                        seats_booked: 1
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    showNotification('J√≠zda rezervov√°na!');
                    searchRides(); // Refresh results
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                showNotification('Chyba p≈ôi rezervaci', 'error');
            }
        }

        function openChat(rideId, driverName) {
            currentChatRide = rideId;
            document.getElementById('chat-title').textContent = `Chat s ${driverName}`;
            document.getElementById('chat-window').style.display = 'block';
            loadChatMessages();
        }

        function closeChat() {
            document.getElementById('chat-window').style.display = 'none';
            currentChatRide = null;
        }

        async function loadChatMessages() {
            if (!currentChatRide) return;

            try {
                const response = await fetch(`/api/chat/${currentChatRide}/messages`);
                const messages = await response.json();
                
                const messagesDiv = document.getElementById('chat-messages');
                messagesDiv.innerHTML = '';
                
                messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.innerHTML = `
                        <strong>${msg.sender_name}:</strong> ${msg.message}
                        <small style="color: #666;">${new Date(msg.timestamp).toLocaleTimeString('cs-CZ')}</small>
                    `;
                    messagesDiv.appendChild(messageDiv);
                });
                
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ zpr√°v:', error);
            }
        }

        async function sendMessage() {
            if (!currentUser || !currentChatRide) return;

            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            try {
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ride_id: currentChatRide,
                        sender_id: currentUser.user_id,
                        sender_name: currentUser.name,
                        message: message
                    })
                });

                if (response.ok) {
                    input.value = '';
                    loadChatMessages();
                } else {
                    showNotification('Chyba p≈ôi odes√≠l√°n√≠ zpr√°vy', 'error');
                }
            } catch (error) {
                showNotification('Chyba p≈ôi odes√≠l√°n√≠ zpr√°vy', 'error');
            }
        }

        async function addFavorite() {
            if (!currentUser) {
                showNotification('P≈ôihlaste se pros√≠m', 'error');
                return;
            }

            const data = {
                name: document.getElementById('fav-name').value,
                from_location: document.getElementById('fav-from').value,
                to_location: document.getElementById('fav-to').value
            };

            try {
                const response = await fetch(`/api/users/${currentUser.user_id}/favorites`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (response.ok) {
                    showNotification('Obl√≠ben√° trasa p≈ôid√°na!');
                    loadFavorites();
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                showNotification('Chyba p≈ôi p≈ôid√°v√°n√≠ obl√≠ben√©', 'error');
            }
        }

        async function loadFavorites() {
            if (!currentUser) return;

            try {
                const response = await fetch(`/api/users/${currentUser.user_id}/favorites`);
                const favorites = await response.json();
                
                const listDiv = document.getElementById('favorites-list');
                listDiv.innerHTML = '<h3>Moje obl√≠ben√© trasy:</h3>';
                
                favorites.forEach(fav => {
                    const favDiv = document.createElement('div');
                    favDiv.className = 'ride-card';
                    favDiv.innerHTML = `
                        <h4>${fav.name}</h4>
                        <p>${fav.from_location} ‚Üí ${fav.to_location}</p>
                        <button class="btn btn-primary" onclick="useFavorite('${fav.from_location}', '${fav.to_location}')">Pou≈æ√≠t pro hled√°n√≠</button>
                    `;
                    listDiv.appendChild(favDiv);
                });
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ obl√≠ben√Ωch:', error);
            }
        }

        function useFavorite(from, to) {
            document.getElementById('search-from').value = from;
            document.getElementById('search-to').value = to;
            showSection('search');
        }

        // Auto-refresh chat messages
        setInterval(() => {
            if (currentChatRide) {
                loadChatMessages();
            }
        }, 3000);

        // Initialize
        showSection('login');
    </script>
</body>
</html>